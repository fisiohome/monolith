<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Monolith</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.13.1/application.js' type='text/javascript'></script>
    <link href='./assets/0.13.1/application.css' media='screen, projection, print' rel='stylesheet' type='text/css' />
    <link rel="icon" type="image/png" href="./assets/0.13.1/favicon_red.png" />
  </head>

  <body>
    <div id="loading">
      <img src="./assets/0.13.1/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" class="hide">
      <div class="timestamp">Generated <abbr class="timeago" title="2025-09-03T08:39:02+00:00">2025-09-03T08:39:02+00:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent">
      <span class="red">
  24.21%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.24
       </span>
    </span> hits/line
    )
  </h2>

  <a name="AllFiles"></a>

  <div>
    <b>32</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>1111</b> relevant lines,
    <span class="green"><b>269</b> lines covered</span> and
    <span class="red"><b>842</b> lines missed. </span>
    (<span class="red">
  24.21%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5f0e474ddcf2b402ebd1be07166109ebd638d936" class="src_link" title="test/controllers/availabilities_controller_test.rb">test/controllers/availabilities_controller_test.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#77fda67e27fe0821db97ce1461fd5ccaa1b51240" class="src_link" title="test/controllers/dashboards_controller_test.rb">test/controllers/dashboards_controller_test.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a5d61be6d79638f896f2450b104904b311c584de" class="src_link" title="test/controllers/therapists_controller_test.rb">test/controllers/therapists_controller_test.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">48</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b37e4888345cc311cc99843656f723955e320317" class="src_link" title="test/controllers/users_controller_test.rb">test/controllers/users_controller_test.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">48</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b56ed153f6d9adaf8d75a30152306f45b09e0e78" class="src_link" title="test/jobs/backfill_therapist_availability_rules_job_test.rb">test/jobs/backfill_therapist_availability_rules_job_test.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#111909a7c4b4bb83d08e6b4e1ed5761458ae32af" class="src_link" title="test/models/address_test.rb">test/models/address_test.rb</a></td>
            <td class="red strong cell--number t-file__coverage">22.00 %</td>
            <td class="cell--number">82</td>
            <td class="cell--number">50</td>
            <td class="cell--number">11</td>
            <td class="cell--number">39</td>
            <td class="cell--number">0.22</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#51833807578a6294305fe705c01de998b7afcf95" class="src_link" title="test/models/admin_test.rb">test/models/admin_test.rb</a></td>
            <td class="red strong cell--number t-file__coverage">34.78 %</td>
            <td class="cell--number">36</td>
            <td class="cell--number">23</td>
            <td class="cell--number">8</td>
            <td class="cell--number">15</td>
            <td class="cell--number">0.35</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#d3f89f2002a87bea53deb3752ffeeabc0644e1be" class="src_link" title="test/models/appointment_address_history_test.rb">test/models/appointment_address_history_test.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#7e2457626227bba786419cf8f07fd5d44d8d6e3c" class="src_link" title="test/models/appointment_admin_test.rb">test/models/appointment_admin_test.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#748162f45f6e81664d821a9350e0fe60d3837a74" class="src_link" title="test/models/appointment_package_history_test.rb">test/models/appointment_package_history_test.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#25afeaa91ca8e077d1038b5eab7f176931889077" class="src_link" title="test/models/appointment_status_history_test.rb">test/models/appointment_status_history_test.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#49fc1eeb8db3174f508b8df680151633cc67c764" class="src_link" title="test/models/appointment_test.rb">test/models/appointment_test.rb</a></td>
            <td class="red strong cell--number t-file__coverage">13.22 %</td>
            <td class="cell--number">1246</td>
            <td class="cell--number">348</td>
            <td class="cell--number">46</td>
            <td class="cell--number">302</td>
            <td class="cell--number">0.13</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#07ab8efcc9b4547e6f447e2ec13dbc08d89c723d" class="src_link" title="test/models/bank_detail_test.rb">test/models/bank_detail_test.rb</a></td>
            <td class="red strong cell--number t-file__coverage">32.26 %</td>
            <td class="cell--number">51</td>
            <td class="cell--number">31</td>
            <td class="cell--number">10</td>
            <td class="cell--number">21</td>
            <td class="cell--number">0.32</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#09a76f0c05c55fd6238e87fe6e90c4f9a559313a" class="src_link" title="test/models/indonesian_area_test.rb">test/models/indonesian_area_test.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#2826d709be9f9724bd38712f9ba69c37530432dc" class="src_link" title="test/models/location_service_test.rb">test/models/location_service_test.rb</a></td>
            <td class="red strong cell--number t-file__coverage">43.75 %</td>
            <td class="cell--number">33</td>
            <td class="cell--number">16</td>
            <td class="cell--number">7</td>
            <td class="cell--number">9</td>
            <td class="cell--number">0.44</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#74cf60cabb5e1114974e5ffd41e8cdc2965748eb" class="src_link" title="test/models/location_test.rb">test/models/location_test.rb</a></td>
            <td class="red strong cell--number t-file__coverage">36.36 %</td>
            <td class="cell--number">61</td>
            <td class="cell--number">33</td>
            <td class="cell--number">12</td>
            <td class="cell--number">21</td>
            <td class="cell--number">0.36</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#3c921bd0aa91713f4b3e31d21a17f2677e7aea9f" class="src_link" title="test/models/package_test.rb">test/models/package_test.rb</a></td>
            <td class="red strong cell--number t-file__coverage">30.19 %</td>
            <td class="cell--number">95</td>
            <td class="cell--number">53</td>
            <td class="cell--number">16</td>
            <td class="cell--number">37</td>
            <td class="cell--number">0.30</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ef434de5f23a850c7afbd65acf58a6764eb3ec80" class="src_link" title="test/models/patient_address_test.rb">test/models/patient_address_test.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c94e692f298f172e69545c68de154faa554ffedd" class="src_link" title="test/models/patient_contact_test.rb">test/models/patient_contact_test.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#66cba5048bf687945f971379156f43f77f6ea40b" class="src_link" title="test/models/patient_medical_record_test.rb">test/models/patient_medical_record_test.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#bc62a2a5107c74776e458987f949da98dbc4ee23" class="src_link" title="test/models/patient_test.rb">test/models/patient_test.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#db6c3fc04efc9a6d9b068ba508bec0c6df7c90da" class="src_link" title="test/models/service_test.rb">test/models/service_test.rb</a></td>
            <td class="red strong cell--number t-file__coverage">27.91 %</td>
            <td class="cell--number">75</td>
            <td class="cell--number">43</td>
            <td class="cell--number">12</td>
            <td class="cell--number">31</td>
            <td class="cell--number">0.28</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#27f5cfa0c92c187ae91d9b0a665f8195dd61ce5e" class="src_link" title="test/models/therapist_address_test.rb">test/models/therapist_address_test.rb</a></td>
            <td class="red strong cell--number t-file__coverage">46.67 %</td>
            <td class="cell--number">42</td>
            <td class="cell--number">15</td>
            <td class="cell--number">7</td>
            <td class="cell--number">8</td>
            <td class="cell--number">0.47</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#fc67656cb640e13aacbd057d585abbd21466e768" class="src_link" title="test/models/therapist_adjusted_availability_test.rb">test/models/therapist_adjusted_availability_test.rb</a></td>
            <td class="red strong cell--number t-file__coverage">20.90 %</td>
            <td class="cell--number">144</td>
            <td class="cell--number">67</td>
            <td class="cell--number">14</td>
            <td class="cell--number">53</td>
            <td class="cell--number">0.21</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#f46ab21382ce9740495ebe2a96ba4d7d74f71813" class="src_link" title="test/models/therapist_appointment_schedule_test.rb">test/models/therapist_appointment_schedule_test.rb</a></td>
            <td class="red strong cell--number t-file__coverage">31.25 %</td>
            <td class="cell--number">64</td>
            <td class="cell--number">32</td>
            <td class="cell--number">10</td>
            <td class="cell--number">22</td>
            <td class="cell--number">0.31</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5a3d4bac68a7fa994e688a5106ffb360c6344653" class="src_link" title="test/models/therapist_bank_detail_test.rb">test/models/therapist_bank_detail_test.rb</a></td>
            <td class="red strong cell--number t-file__coverage">46.15 %</td>
            <td class="cell--number">34</td>
            <td class="cell--number">13</td>
            <td class="cell--number">6</td>
            <td class="cell--number">7</td>
            <td class="cell--number">0.46</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a8105570b3cf89c34efe160f8b414b9c6fb15fe9" class="src_link" title="test/models/therapist_document_test.rb">test/models/therapist_document_test.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4da96644ea61e1d5cfc3492257346e96e42606fb" class="src_link" title="test/models/therapist_registration_counter_test.rb">test/models/therapist_registration_counter_test.rb</a></td>
            <td class="red strong cell--number t-file__coverage">38.46 %</td>
            <td class="cell--number">22</td>
            <td class="cell--number">13</td>
            <td class="cell--number">5</td>
            <td class="cell--number">8</td>
            <td class="cell--number">0.38</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c906e8fe18a88f9f9709fbcacf16b44a5fe37521" class="src_link" title="test/models/therapist_test.rb">test/models/therapist_test.rb</a></td>
            <td class="red strong cell--number t-file__coverage">28.38 %</td>
            <td class="cell--number">121</td>
            <td class="cell--number">74</td>
            <td class="cell--number">21</td>
            <td class="cell--number">53</td>
            <td class="cell--number">0.28</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#3deed34800fdf4b7eb4811d40e43493ba896409f" class="src_link" title="test/models/therapist_weekly_availability_test.rb">test/models/therapist_weekly_availability_test.rb</a></td>
            <td class="red strong cell--number t-file__coverage">21.57 %</td>
            <td class="cell--number">100</td>
            <td class="cell--number">51</td>
            <td class="cell--number">11</td>
            <td class="cell--number">40</td>
            <td class="cell--number">0.22</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e28a5acdcfc98cab9bf1b59744cf20f81c92f8d1" class="src_link" title="test/models/user_test.rb">test/models/user_test.rb</a></td>
            <td class="red strong cell--number t-file__coverage">39.53 %</td>
            <td class="cell--number">88</td>
            <td class="cell--number">43</td>
            <td class="cell--number">17</td>
            <td class="cell--number">26</td>
            <td class="cell--number">0.40</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ac1e39d28f1e38c290d083107b680566fa81420e" class="src_link" title="test/services/get_therapist_available_service_test.rb">test/services/get_therapist_available_service_test.rb</a></td>
            <td class="red strong cell--number t-file__coverage">14.77 %</td>
            <td class="cell--number">575</td>
            <td class="cell--number">176</td>
            <td class="cell--number">26</td>
            <td class="cell--number">150</td>
            <td class="cell--number">0.15</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>


        
      </div>

      <div id="footer">
        Generated by <a href="https://github.com/simplecov-ruby/simplecov">simplecov</a> v0.22.0
        and simplecov-html v0.13.1<br/>
        using Minitest
      </div>

      <div class="source_files">
      
        <div class="source_table" id="5f0e474ddcf2b402ebd1be07166109ebd638d936">
  <div class="header">
    <h3>test/controllers/availabilities_controller_test.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class AvailabilitiesControllerTest &lt; ActionDispatch::IntegrationTest</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # test &quot;the truth&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  #   assert true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="77fda67e27fe0821db97ce1461fd5ccaa1b51240">
  <div class="header">
    <h3>test/controllers/dashboards_controller_test.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class DashboardsControllerTest &lt; ActionDispatch::IntegrationTest</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # test &quot;the truth&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  #   assert true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a5d61be6d79638f896f2450b104904b311c584de">
  <div class="header">
    <h3>test/controllers/therapists_controller_test.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class TherapistsControllerTest &lt; ActionDispatch::IntegrationTest</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # setup do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  #   @therapist = therapists(:one)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  # test &quot;should get index&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  #   get therapists_url</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  #   assert_response :success</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  # test &quot;should get new&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">  #   get new_therapist_url</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">  #   assert_response :success</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">  # test &quot;should create therapist&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  #   assert_difference(&quot;Therapist.count&quot;) do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">  #     post therapists_url, params: {therapist: {}}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  #   end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">  #   assert_redirected_to therapist_url(Therapist.last)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">  # test &quot;should show therapist&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">  #   get therapist_url(@therapist)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">  #   assert_response :success</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">  # test &quot;should get edit&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">  #   get edit_therapist_url(@therapist)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">  #   assert_response :success</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">  # test &quot;should update therapist&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">  #   patch therapist_url(@therapist), params: {therapist: {}}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">  #   assert_redirected_to therapist_url(@therapist)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">  # test &quot;should destroy therapist&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">  #   assert_difference(&quot;Therapist.count&quot;, -1) do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">  #     delete therapist_url(@therapist)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">  #   end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">  #   assert_redirected_to therapists_url</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b37e4888345cc311cc99843656f723955e320317">
  <div class="header">
    <h3>test/controllers/users_controller_test.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class UsersControllerTest &lt; ActionDispatch::IntegrationTest</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # setup do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  #   @user = users(:one)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  # test &quot;should get index&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  #   get users_url</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  #   assert_response :success</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  # test &quot;should get new&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">  #   get new_user_url</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">  #   assert_response :success</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">  # test &quot;should create user&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  #   assert_difference(&quot;User.count&quot;) do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">  #     post users_url, params: {user: {}}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  #   end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">  #   assert_redirected_to user_url(User.last)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">  # test &quot;should show user&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">  #   get user_url(@user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">  #   assert_response :success</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">  # test &quot;should get edit&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">  #   get edit_user_url(@user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">  #   assert_response :success</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">  # test &quot;should update user&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">  #   patch user_url(@user), params: {user: {}}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">  #   assert_redirected_to user_url(@user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">  # test &quot;should destroy user&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">  #   assert_difference(&quot;User.count&quot;, -1) do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">  #     delete user_url(@user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">  #   end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">  #   assert_redirected_to users_url</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b56ed153f6d9adaf8d75a30152306f45b09e0e78">
  <div class="header">
    <h3>test/jobs/backfill_therapist_availability_rules_job_test.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class BackfillTherapistAvailabilityRulesJobTest &lt; ActiveJob::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # test &quot;the truth&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  #   assert true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="111909a7c4b4bb83d08e6b4e1ed5761458ae32af">
  <div class="header">
    <h3>test/models/address_test.rb</h3>
    <h4>
      <span class="red">
  22.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>50</b> relevant lines.
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>39</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class AddressTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def setup</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @jakarta_address = addresses(:jakarta_selatan_address)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @bandung_address = addresses(:bandung_address)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  # Test validations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;valid address should be valid&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    assert @jakarta_address.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    assert @bandung_address.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;address should validate presence of latitude&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    @jakarta_address.latitude = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    assert_not @jakarta_address.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    assert_includes @jakarta_address.errors[:latitude], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="21">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;address should validate presence of longitude&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    @jakarta_address.longitude = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    assert_not @jakarta_address.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    assert_includes @jakarta_address.errors[:longitude], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="27">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;address should validate presence of address&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    @jakarta_address.address = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    assert_not @jakarta_address.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    assert_includes @jakarta_address.errors[:address], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="33">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;address should be valid even without a postal_code&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    @jakarta_address.postal_code = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    assert @jakarta_address.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    assert_empty @jakarta_address.errors[:postal_code]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">  # Test associations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="40">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should destroy associated therapist_addresses when address is destroyed&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    assert_difference &quot;TherapistAddress.count&quot;, -1 do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">      @jakarta_address.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="46">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should have many therapists through therapist_addresses&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">    therapist = therapists(:therapist_one)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    TherapistAddress.create!(address: @jakarta_address, therapist: therapist)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    assert_includes @jakarta_address.therapists, therapist</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">  # Test callbacks</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="53">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;update_coordinates should set coordinates as an array of latitude and longitude when latitude or longitude changes&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">    # Case 1: Change latitude and longitude</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    @jakarta_address.latitude = -6.2277</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">    @jakarta_address.longitude = 106.8414</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">    @jakarta_address.save!</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">    assert_equal [-6.2277, 106.8414], @jakarta_address.coordinates, &quot;Coordinates should update correctly when both latitude and longitude change&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">    # Case 2: Change only latitude</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    @jakarta_address.latitude = -6.3000</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    @jakarta_address.save!</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">    assert_equal [-6.3000, 106.8414], @jakarta_address.coordinates, &quot;Coordinates should update correctly when only latitude changes&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">    # Case 3: Change only longitude</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">    @jakarta_address.longitude = 107.0000</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">    @jakarta_address.save!</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">    assert_equal [-6.3000, 107.0000], @jakarta_address.coordinates, &quot;Coordinates should update correctly when only longitude changes&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">    # Case 4: No changes to latitude or longitude</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">    coordinates_before = @jakarta_address.coordinates.dup</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">    @jakarta_address.save!</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    assert_equal coordinates_before, @jakarta_address.coordinates, &quot;Coordinates should not change if latitude and longitude remain unchanged&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">    # Case 5: Test with nil latitude and longitude</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">    @jakarta_address.latitude = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">    @jakarta_address.longitude = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">    assert_not @jakarta_address.valid?, &quot;Address should not be valid without latitude and longitude&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">    assert_includes @jakarta_address.errors[:latitude], &quot;can&#39;t be blank&quot;, &quot;Validation should ensure latitude is present&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">    assert_includes @jakarta_address.errors[:longitude], &quot;can&#39;t be blank&quot;, &quot;Validation should ensure longitude is present&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="51833807578a6294305fe705c01de998b7afcf95">
  <div class="header">
    <h3>test/models/admin_test.rb</h3>
    <h4>
      <span class="red">
  34.78%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>23</b> relevant lines.
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>15</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class AdminTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def setup</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @super_admin = admins(:super_admin)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @admin = admins(:admin)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;valid admin should be valid&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    assert @super_admin.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    assert @admin.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;invalid admin type should be invalid&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    @super_admin.admin_type = &quot;INVALID_TYPE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    assert_not @super_admin.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    assert_includes @super_admin.errors[:admin_type], &quot;INVALID_TYPE is not a valid admin type&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="20">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should validate presence of name&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    @admin.name = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    assert_not @admin.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    assert_includes @admin.errors[:name], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="26">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;super_admin check should return true only for SUPER_ADMIN&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    assert @super_admin.is_super_admin?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    assert_not @admin.is_super_admin?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="31">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;destroying admin should destroy associated user&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    user = @super_admin.user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">    @super_admin.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    assert_not User.exists?(user.id), &quot;Associated user was not destroyed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d3f89f2002a87bea53deb3752ffeeabc0644e1be">
  <div class="header">
    <h3>test/models/appointment_address_history_test.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class AppointmentAddressHistoryTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # test &quot;the truth&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  #   assert true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="7e2457626227bba786419cf8f07fd5d44d8d6e3c">
  <div class="header">
    <h3>test/models/appointment_admin_test.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class AppointmentAdminTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # test &quot;the truth&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  #   assert true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="748162f45f6e81664d821a9350e0fe60d3837a74">
  <div class="header">
    <h3>test/models/appointment_package_history_test.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class AppointmentPackageHistoryTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # test &quot;the truth&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  #   assert true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="25afeaa91ca8e077d1038b5eab7f176931889077">
  <div class="header">
    <h3>test/models/appointment_status_history_test.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class AppointmentStatusHistoryTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # test &quot;the truth&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  #   assert true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="49fc1eeb8db3174f508b8df680151633cc67c764">
  <div class="header">
    <h3>test/models/appointment_test.rb</h3>
    <h4>
      <span class="red">
  13.22%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>348</b> relevant lines.
      <span class="green"><b>46</b> lines covered</span> and
      <span class="red"><b>302</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class AppointmentTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def setup</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @service = services(:fisiohome_special_tier)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @user = User.create!(email: &quot;rina@example.com&quot;, password: &quot;password&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    @therapist = therapists(:therapist_one)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    @patient_contact = PatientContact.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">      contact_name: &quot;Budi&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">      contact_phone: &quot;6289172818&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">      email: &quot;budi@yopmail.com&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    @patient = Patient.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">      name: &quot;Budi&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">      date_of_birth: &quot;2000-01-01&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">      gender: &quot;MALE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">      patient_contact: @patient_contact</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    @package = Package.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">      name: &quot;Paket 1&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">      currency: &quot;IDR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">      number_of_visit: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">      price_per_visit: 100_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">      total_price: 100_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">      fee_per_visit: 70_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">      total_fee: 70_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">      active: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    @location = Location.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">      country: &quot;Indonesia&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">      country_code: &quot;ID&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">      state: &quot;Jakarta&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">      city: &quot;Jakarta&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    @schedule = TherapistAppointmentSchedule.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">      appointment_duration_in_minutes: 60,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">      buffer_time_in_minutes: 15,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">      max_daily_appointments: 4,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">      available_now: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">    @future_time = 2.days.from_now</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">    @patient_medical_record = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      complaint_description: &quot;Shoulder pain&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">      illness_onset_date: &quot;2 weeks ago&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">      condition: &quot;NORMAL&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">      medical_history: &quot;just flu&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="52">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;blocks a 5th appointment for a therapist with informative error, about max_daily_appointments&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">    @patient_contacts = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">    @patients = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    4.times do |i|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">      contact = PatientContact.create!(contact_name: &quot;Patient#{i}&quot;, contact_phone: &quot;6289172123#{i}&quot;, email: &quot;patient#{i}@yopmail.com&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">      @patient_contacts &lt;&lt; contact</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">      @patients &lt;&lt; Patient.create!(name: &quot;Patient#{i}&quot;, date_of_birth: &quot;2000-01-01&quot;, gender: &quot;MALE&quot;, patient_contact: contact)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    4.times do |i|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">      Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">        therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">        patient: @patients[i], # again, different patients</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">        service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">        package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">        location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">        appointment_date_time: @future_time.change(hour: 8 + i),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">        preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">    # 5th appointment, another patient</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">    new_patient_contact = PatientContact.create!(contact_name: &quot;Overflow&quot;, contact_phone: &quot;628917212321&quot;, email: &quot;overflow@yopmail.com&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">    new_patient = Patient.create!(name: &quot;Overflow&quot;, date_of_birth: &quot;2000-01-01&quot;, gender: &quot;MALE&quot;, patient_contact: new_patient_contact)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">    appt = Appointment.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">      patient: new_patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">      appointment_date_time: @future_time.change(hour: 14),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">    assert_equal 4, Appointment.where(therapist: @therapist, appointment_date_time: @future_time.all_day).count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">    assert_not appt.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">    assert_includes appt.errors[:base].join, &quot;already assigned 4 appointments&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">    assert_includes appt.errors[:base].join, &quot;Please choose another day&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="93">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;does not allow appointments in the past, about appointment_date_time_in_the_future&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">    appt = Appointment.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">      appointment_date_time: 1.day.ago,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">    assert_not appt.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">    assert_includes appt.errors[:appointment_date_time], &quot;must be in the future&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="107">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;validates uniqueness of registration_number and visit_number combination&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">    # First appointment is valid</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">    Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">      registration_number: &quot;UNIQUE_REG&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">      visit_number: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">      appointment_date_time: @future_time.change(hour: 10),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">    # Duplicate registration_number and visit_number is invalid</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">    duplicate_appt = Appointment.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby">      registration_number: &quot;UNIQUE_REG&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            

            <code class="ruby">      visit_number: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby">      appointment_date_time: @future_time.change(hour: 12),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">    assert_not duplicate_appt.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">    assert_includes duplicate_appt.errors[:registration_number], &quot;has already been taken&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby">    # Same registration_number but different visit_number is valid</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">    series_appt = Appointment.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby">      registration_number: &quot;UNIQUE_REG&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby">      visit_number: 2,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby">      appointment_date_time: @future_time.change(hour: 14),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">    assert series_appt.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="148">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;auto-generates a registration_number if none is provided, about generate_registration_number&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">    appt = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            

            <code class="ruby">      # note: no registration_number</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby">      appointment_date_time: @future_time.change(hour: 9),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby">    # Should be SERVICECODE-XXXXXX (6 digits)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">    assert_match(/\A#{@service.code.upcase}-\d{6}\z/, appt.registration_number)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="164">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;prevents overlapping appointments for the same patient, about no_overlapping_appointments&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="165">
            

            

            <code class="ruby">    # Existing appointment: 10:00-11:00</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">    Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            

            <code class="ruby">      appointment_date_time: @future_time.change(hour: 10),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="173">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            

            <code class="ruby">    # Try overlapping: 10:30-11:30</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">    appt = Appointment.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="181">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="182">
            

            

            <code class="ruby">      appointment_date_time: @future_time.change(hour: 10, min: 30),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="185">
            

            

            <code class="ruby">    assert_not appt.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">    assert_includes appt.errors[:appointment_date_time].join, &quot;overlaps with&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="187">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="188">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="189">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;prevents duplicate appointment time for the same patient, about no_duplicate_appointment_time&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="190">
            

            

            <code class="ruby">    # first appointment at 9am</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="191">
            

            

            <code class="ruby">    Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="192">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="193">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="194">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="195">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="196">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="197">
            

            

            <code class="ruby">      appointment_date_time: @future_time.change(hour: 9),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="198">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="199">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="200">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="201">
            

            

            <code class="ruby">    # second one exactly same time</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="202">
            

            

            <code class="ruby">    appt = Appointment.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="203">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="204">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="205">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="206">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="207">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="208">
            

            

            <code class="ruby">      appointment_date_time: @future_time.change(hour: 9),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="209">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="210">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="211">
            

            

            <code class="ruby">    assert_not appt.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="212">
            

            

            <code class="ruby">    assert_includes appt.errors[:appointment_date_time].join, &quot;already has an appointment&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="213">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="214">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="215">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;initial visit must have an appointment date/time, about initial_visit_requirements&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="216">
            

            

            <code class="ruby">    appt = Appointment.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="217">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="218">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="219">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="220">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="221">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="222">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="223">
            

            

            <code class="ruby">      # note: no appointment_date_time</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="224">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="225">
            

            

            <code class="ruby">    assert_not appt.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="226">
            

            

            <code class="ruby">    assert_includes appt.errors[:appointment_date_time], &quot;must be present for initial visit&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="227">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="228">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="229">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;start_time and end_time return the correctly formatted strings, about return start_time and end_time&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="230">
            

            

            <code class="ruby">    # given 60min duration + 15min buffer</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="231">
            

            

            <code class="ruby">    appt = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="232">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="233">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="234">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="235">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="236">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="237">
            

            

            <code class="ruby">      appointment_date_time: @future_time.change(hour: 8, min: 5),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="238">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="239">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="240">
            

            

            <code class="ruby">    # starts at 08:05, ends at 09:20</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="241">
            

            

            <code class="ruby">    assert_equal &quot;08:05&quot;, appt.start_time</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="242">
            

            

            <code class="ruby">    assert_equal &quot;09:20&quot;, appt.end_time</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="243">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="244">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="245">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;total_duration_minutes returns correct sum of duration and buffer, about return total_duration_minutes&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="246">
            

            

            <code class="ruby">    sched = @therapist.therapist_appointment_schedule</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="247">
            

            

            <code class="ruby">    expected = sched.appointment_duration_in_minutes + sched.buffer_time_in_minutes</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="248">
            

            

            <code class="ruby">    appt = Appointment.new(therapist: @therapist)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="249">
            

            

            <code class="ruby">    assert_equal expected, appt.total_duration_minutes</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="250">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="251">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="252">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;requires a therapist when marking an appointment paid, about validate_paid_requires_therapist&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="253">
            

            

            <code class="ruby">    appt = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="254">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="255">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="256">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="257">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="258">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="259">
            

            

            <code class="ruby">      appointment_date_time: @future_time.change(hour: 11),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="260">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="261">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="262">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="263">
            

            

            <code class="ruby">    # simulate a paid-reschedule: drop therapist and flip to paid</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="264">
            

            

            <code class="ruby">    appt.therapist = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="265">
            

            

            <code class="ruby">    appt.status = &quot;paid&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="266">
            

            

            <code class="ruby">    appt.valid?  # trigger validations</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="267">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="268">
            

            

            <code class="ruby">    assert_includes appt.errors[:therapist_id], &quot;must be selected when rescheduling a paid appointment&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="269">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="270">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="271">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;visit_number cannot exceed package&#39;s total visits, about validate_visit_sequence&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="272">
            

            

            <code class="ruby">    small_pkg = Package.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="273">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="274">
            

            

            <code class="ruby">      name: &quot;Small Pack&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="275">
            

            

            <code class="ruby">      currency: &quot;IDR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="276">
            

            

            <code class="ruby">      number_of_visit: 2,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="277">
            

            

            <code class="ruby">      price_per_visit: 50_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="278">
            

            

            <code class="ruby">      total_price: 100_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="279">
            

            

            <code class="ruby">      fee_per_visit: 35_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="280">
            

            

            <code class="ruby">      total_fee: 70_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="281">
            

            

            <code class="ruby">      active: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="282">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="283">
            

            

            <code class="ruby">    appt = Appointment.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="284">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="285">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="286">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="287">
            

            

            <code class="ruby">      package: small_pkg,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="288">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="289">
            

            

            <code class="ruby">      visit_number: 3,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="290">
            

            

            <code class="ruby">      appointment_date_time: @future_time.change(hour: 9),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="291">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="292">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="293">
            

            

            <code class="ruby">    assert_not appt.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="294">
            

            

            <code class="ruby">    assert_includes appt.errors[:visit_number], &quot;exceeds package&#39;s total visits of 2&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="295">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="296">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="297">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;initial visit automatically spawns unscheduled series appointments, about create_series_appointments&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="298">
            

            

            <code class="ruby">    #  Setup a 3-visit package </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="299">
            

            

            <code class="ruby">    triple_pkg = Package.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="300">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="301">
            

            

            <code class="ruby">      name: &quot;3-Visit Bundle&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="302">
            

            

            <code class="ruby">      currency: &quot;IDR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="303">
            

            

            <code class="ruby">      number_of_visit: 3,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="304">
            

            

            <code class="ruby">      price_per_visit: 100_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="305">
            

            

            <code class="ruby">      total_price: 300_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="306">
            

            

            <code class="ruby">      fee_per_visit: 70_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="307">
            

            

            <code class="ruby">      total_fee: 210_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="308">
            

            

            <code class="ruby">      active: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="309">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="310">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="311">
            

            

            <code class="ruby">    #  Create the FIRST visit (visit_number defaults to 1) </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="312">
            

            

            <code class="ruby">    first_visit = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="313">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="314">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="315">
            

            

            <code class="ruby">      package: triple_pkg,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="316">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="317">
            

            

            <code class="ruby">      appointment_date_time: @future_time.change(hour: 9),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="318">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="319">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="320">
            

            

            <code class="ruby">      skip_auto_series_creation: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="321">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="322">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="323">
            

            

            <code class="ruby">    #  Expectations </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="324">
            

            

            <code class="ruby">    assert_equal 2, first_visit.series_appointments.count, &quot;should create two follow-up visits&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="325">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="326">
            

            

            <code class="ruby">    assert first_visit.series_appointments.all? { |c| c.registration_number == first_visit.registration_number },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="327">
            

            

            <code class="ruby">      &quot;all series appointments should have the same registration number as the initial visit&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="328">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="329">
            

            

            <code class="ruby">    visit_numbers = first_visit.series_appointments.order(:visit_number).pluck(:visit_number)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="330">
            

            

            <code class="ruby">    assert_equal [2, 3], visit_numbers, &quot;follow-ups should be visit #2 and #3&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="331">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="332">
            

            

            <code class="ruby">    assert first_visit.series_appointments.all?(&amp;:unscheduled?), &quot;each child should start UNSCHEDULED&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="333">
            

            

            <code class="ruby">    assert first_visit.series_appointments.all? { |c| c.appointment_reference_id == first_visit.id },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="334">
            

            

            <code class="ruby">      &quot;each child should point back to the initial visit&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="335">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="336">
            

            

            <code class="ruby">    # every child gets a stubbed or copied medical record</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="337">
            

            

            <code class="ruby">    assert first_visit.series_appointments.all? { |c| c.patient_medical_record.present? },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="338">
            

            

            <code class="ruby">      &quot;each child visit should have its own medical record&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="339">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="340">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="341">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;requires other_referral_source if referral_source is &#39;Other&#39;, about referral_source and other_referral_source validation&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="342">
            

            

            <code class="ruby">    # 1. A normal scenario should be valid (referral_source != &quot;Other&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="343">
            

            

            <code class="ruby">    normal_appt = Appointment.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="344">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="345">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="346">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="347">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="348">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="349">
            

            

            <code class="ruby">      appointment_date_time: @future_time.change(hour: 9),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="350">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="351">
            

            

            <code class="ruby">      referral_source: &quot;Instagram&quot;    # Not &quot;Other&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="352">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="353">
            

            

            <code class="ruby">    assert normal_appt.valid?, &quot;Appointment should be valid when referral_source != &#39;Other&#39;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="354">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="355">
            

            

            <code class="ruby">    # 2. If referral_source is &quot;Other&quot;, then other_referral_source is required</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="356">
            

            

            <code class="ruby">    other_appt = Appointment.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="357">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="358">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="359">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="360">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="361">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="362">
            

            

            <code class="ruby">      appointment_date_time: @future_time.change(hour: 10),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="363">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="364">
            

            

            <code class="ruby">      referral_source: &quot;Other&quot;        # Must fill in other_referral_source</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="365">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="366">
            

            

            <code class="ruby">    assert_not other_appt.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="367">
            

            

            <code class="ruby">    assert_includes other_appt.errors[:other_referral_source], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="368">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="369">
            

            

            <code class="ruby">    # 3. Fix it by providing other_referral_source</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="370">
            

            

            <code class="ruby">    other_appt.other_referral_source = &quot;Google Ads&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="371">
            

            

            <code class="ruby">    assert other_appt.valid?, &quot;Appointment should be valid once other_referral_source is set&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="372">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="373">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="374">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;validates Fisiohome partner booking requirements, about fisiohome_partner_name and other_fisiohome_partner_name validation&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="375">
            

            

            <code class="ruby">    # Scenario 1: Valid when partner booking is false (default)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="376">
            

            

            <code class="ruby">    appt = Appointment.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="377">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="378">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="379">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="380">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="381">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="382">
            

            

            <code class="ruby">      appointment_date_time: @future_time.change(hour: 9),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="383">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="384">
            

            

            <code class="ruby">      fisiohome_partner_booking: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="385">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="386">
            

            

            <code class="ruby">    assert appt.valid?, &quot;Should be valid when not a partner booking&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="387">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="388">
            

            

            <code class="ruby">    # Scenario 2: Invalid when partner booking is true but no partner selected</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="389">
            

            

            <code class="ruby">    appt.fisiohome_partner_booking = true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="390">
            

            

            <code class="ruby">    assert_not appt.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="391">
            

            

            <code class="ruby">    assert_includes appt.errors[:fisiohome_partner_name], &quot;is not included in the list&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="392">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="393">
            

            

            <code class="ruby">    # Scenario 3: Valid with partner name from list</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="394">
            

            

            <code class="ruby">    appt.fisiohome_partner_name = &quot;Cosmart&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="395">
            

            

            <code class="ruby">    assert appt.valid?, &quot;Should accept valid partner name&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="396">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="397">
            

            

            <code class="ruby">    # Scenario 4: Requires &#39;other&#39; name when partner is &#39;Other&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="398">
            

            

            <code class="ruby">    appt.fisiohome_partner_name = &quot;Other&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="399">
            

            

            <code class="ruby">    assert_not appt.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="400">
            

            

            <code class="ruby">    assert_includes appt.errors[:other_fisiohome_partner_name], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="401">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="402">
            

            

            <code class="ruby">    # Scenario 5: Valid with &#39;Other&#39; and explanation</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="403">
            

            

            <code class="ruby">    appt.other_fisiohome_partner_name = &quot;HealthPlus Clinic&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="404">
            

            

            <code class="ruby">    assert appt.valid?, &quot;Should accept &#39;Other&#39; with explanation&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="405">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="406">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="407">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;snapshots package_history on create, about snapshot_package_history&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="408">
            

            

            <code class="ruby">    # create the appointment (no explicit history yet)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="409">
            

            

            <code class="ruby">    appt = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="410">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="411">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="412">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="413">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="414">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="415">
            

            

            <code class="ruby">      # we omit registration_number to let the callback generate it</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="416">
            

            

            <code class="ruby">      appointment_date_time: @future_time.change(hour: 10),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="417">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="418">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="419">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="420">
            

            

            <code class="ruby">    # it should have created exactly one package_history</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="421">
            

            

            <code class="ruby">    ph = appt.package_history</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="422">
            

            

            <code class="ruby">    assert_not_nil ph, &quot;expected a package_history record to be created&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="423">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="424">
            

            

            <code class="ruby">    # and its fields should match the package at creation time</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="425">
            

            

            <code class="ruby">    assert_equal @package.id, ph.package_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="426">
            

            

            <code class="ruby">    assert_equal @package.name, ph.name</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="427">
            

            

            <code class="ruby">    assert_equal @package.currency, ph.currency</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="428">
            

            

            <code class="ruby">    assert_equal @package.number_of_visit, ph.number_of_visit</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="429">
            

            

            <code class="ruby">    assert_equal @package.price_per_visit, ph.price_per_visit</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="430">
            

            

            <code class="ruby">    assert_nil @package.discount, &quot;Expected package discount to be nil&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="431">
            

            

            <code class="ruby">    assert_nil ph.discount, &quot;Expected package history discount to be nil&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="432">
            

            

            <code class="ruby">    assert_equal @package.total_price, ph.total_price</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="433">
            

            

            <code class="ruby">    assert_equal @package.fee_per_visit, ph.fee_per_visit</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="434">
            

            

            <code class="ruby">    assert_equal @package.total_fee, ph.total_fee</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="435">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="436">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="437">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;allows valid status transitions, about valid_status_transition&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="438">
            

            

            <code class="ruby">    appt = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="439">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="440">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="441">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="442">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="443">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="444">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="445">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="446">
            

            

            <code class="ruby">      status: :pending_patient_approval</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="447">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="448">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="449">
            

            

            <code class="ruby">    assert appt.update(status: :pending_payment)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="450">
            

            

            <code class="ruby">    assert appt.update(status: :paid)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="451">
            

            

            <code class="ruby">    assert appt.update(status: :cancelled)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="452">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="453">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="454">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;cancelling the initial visit cascades to every series appointment, about cascade_cancellation&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="455">
            

            

            <code class="ruby">    triple_pkg = Package.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="456">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="457">
            

            

            <code class="ruby">      name: &quot;3-Visit Bundle&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="458">
            

            

            <code class="ruby">      currency: &quot;IDR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="459">
            

            

            <code class="ruby">      number_of_visit: 3,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="460">
            

            

            <code class="ruby">      price_per_visit: 100_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="461">
            

            

            <code class="ruby">      total_price: 300_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="462">
            

            

            <code class="ruby">      fee_per_visit: 70_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="463">
            

            

            <code class="ruby">      total_fee: 210_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="464">
            

            

            <code class="ruby">      active: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="465">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="466">
            

            

            <code class="ruby">    first_visit = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="467">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="468">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="469">
            

            

            <code class="ruby">      package: triple_pkg,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="470">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="471">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="472">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="473">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="474">
            

            

            <code class="ruby">      updater: @user,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="475">
            

            

            <code class="ruby">      skip_auto_series_creation: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="476">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="477">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="478">
            

            

            <code class="ruby">    #  Sanity check </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="479">
            

            

            <code class="ruby">    assert_equal 2, first_visit.series_appointments.count, &quot;setup should have spawned two child visits&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="480">
            

            

            <code class="ruby">    assert first_visit.series_appointments.all?(&amp;:unscheduled?), &quot;children start UNSCHEDULED&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="481">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="482">
            

            

            <code class="ruby">    #  Perform the cancellation </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="483">
            

            

            <code class="ruby">    first_visit.status_reason = &quot;Patient requested&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="484">
            

            

            <code class="ruby">    first_visit.updater = @user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="485">
            

            

            <code class="ruby">    assert first_visit.cancel!, &quot;initial visit cancellation should succeed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="486">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="487">
            

            

            <code class="ruby">    #  Expectations </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="488">
            

            

            <code class="ruby">    first_visit.reload</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="489">
            

            

            <code class="ruby">    assert_equal &quot;cancelled&quot;, first_visit.status</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="490">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="491">
            

            

            <code class="ruby">    first_visit.series_appointments.each do |child|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="492">
            

            

            <code class="ruby">      child.reload</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="493">
            

            

            <code class="ruby">      assert_equal &quot;cancelled&quot;, child.status, &quot;series visit #{child.visit_number} should also be cancelled&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="494">
            

            

            <code class="ruby">      assert_equal first_visit.id, child.appointment_reference_id, &quot;child should still point to its root&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="495">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="496">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="497">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="498">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;assign_therapist! moves UNSCHEDULED  PENDING PATIENT APPROVAL and records history, about assign_therapist!&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="499">
            

            

            <code class="ruby">    first_visit = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="500">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="501">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="502">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="503">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="504">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="505">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="506">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="507">
            

            

            <code class="ruby">      updater: @user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="508">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="509">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="510">
            

            

            <code class="ruby">    # sanity check</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="511">
            

            

            <code class="ruby">    assert_equal &quot;pending_therapist_assignment&quot;, first_visit.status</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="512">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="513">
            

            

            <code class="ruby">    # fill in the scheduling data exactly as ops would</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="514">
            

            

            <code class="ruby">    first_visit.therapist = @therapist</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="515">
            

            

            <code class="ruby">    first_visit.appointment_date_time = 3.days.from_now.change(hour: 10)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="516">
            

            

            <code class="ruby">    first_visit.status_reason = &quot;Therapist assigned by OPS&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="517">
            

            

            <code class="ruby">    first_visit.updater = @user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="518">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="519">
            

            

            <code class="ruby">    assert_difference &quot;AppointmentStatusHistory.count&quot;, 1 do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="520">
            

            

            <code class="ruby">      assert first_visit.assign_therapist!, &quot;method should succeed when therapist &amp; time are present&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="521">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="522">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="523">
            

            

            <code class="ruby">    # expectations</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="524">
            

            

            <code class="ruby">    first_visit.reload</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="525">
            

            

            <code class="ruby">    assert_equal &quot;pending_patient_approval&quot;, first_visit.status</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="526">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="527">
            

            

            <code class="ruby">    last_history = first_visit.status_histories.order(:created_at).last</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="528">
            

            

            <code class="ruby">    assert_equal &quot;PENDING THERAPIST ASSIGNMENT&quot;, last_history.old_status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="529">
            

            

            <code class="ruby">    assert_equal &quot;PENDING PATIENT APPROVAL&quot;, last_history.new_status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="530">
            

            

            <code class="ruby">    assert_equal @user.id, last_history.changed_by</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="531">
            

            

            <code class="ruby">    assert_equal &quot;Therapist assigned by OPS&quot;, last_history.reason</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="532">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="533">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="534">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;a series visit cannot advance to a status that is ahead of its root, about series_status_cannot_outpace_root&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="535">
            

            

            <code class="ruby">    triple_pkg = Package.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="536">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="537">
            

            

            <code class="ruby">      name: &quot;3-Visit Bundle&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="538">
            

            

            <code class="ruby">      currency: &quot;IDR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="539">
            

            

            <code class="ruby">      number_of_visit: 3,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="540">
            

            

            <code class="ruby">      price_per_visit: 100_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="541">
            

            

            <code class="ruby">      total_price: 300_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="542">
            

            

            <code class="ruby">      fee_per_visit: 70_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="543">
            

            

            <code class="ruby">      total_fee: 210_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="544">
            

            

            <code class="ruby">      active: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="545">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="546">
            

            

            <code class="ruby">    first_visit = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="547">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="548">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="549">
            

            

            <code class="ruby">      package: triple_pkg,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="550">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="551">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="552">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="553">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="554">
            

            

            <code class="ruby">      updater: @user,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="555">
            

            

            <code class="ruby">      skip_auto_series_creation: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="556">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="557">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="558">
            

            

            <code class="ruby">    # sanity check</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="559">
            

            

            <code class="ruby">    child = first_visit.series_appointments.order(:visit_number).first</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="560">
            

            

            <code class="ruby">    assert child.unscheduled?, &quot;child should start UNSCHEDULED&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="561">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="562">
            

            

            <code class="ruby">    # Try to move the child to PENDING PATIENT APPROVAL (allowed transition from UNSCHEDULED)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="563">
            

            

            <code class="ruby">    child.assign_attributes(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="564">
            

            

            <code class="ruby">      status: :pending_patient_approval,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="565">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="566">
            

            

            <code class="ruby">      appointment_date_time: 4.days.from_now.change(hour: 10),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="567">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="568">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="569">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="570">
            

            

            <code class="ruby">    assert_not child.valid?, &quot;validation should fail because root is still PENDING THERAPIST ASSIGNMENT&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="571">
            

            

            <code class="ruby">    assert_includes child.errors[:status].join,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="572">
            

            

            <code class="ruby">      &quot;cannot be ahead of first visit (#{first_visit.registration_number}) status (Awaiting Therapist)&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="573">
            

            

            <code class="ruby">      &quot;error message should mention the root appointment&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="574">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="575">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="576">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;initial visit cannot be moved to a date later than any series visit, about validate_initial_visit_position&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="577">
            

            

            <code class="ruby">    triple_pkg = Package.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="578">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="579">
            

            

            <code class="ruby">      name: &quot;3-Visit Bundle&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="580">
            

            

            <code class="ruby">      currency: &quot;IDR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="581">
            

            

            <code class="ruby">      number_of_visit: 3,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="582">
            

            

            <code class="ruby">      price_per_visit: 100_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="583">
            

            

            <code class="ruby">      total_price: 300_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="584">
            

            

            <code class="ruby">      fee_per_visit: 70_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="585">
            

            

            <code class="ruby">      total_fee: 210_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="586">
            

            

            <code class="ruby">      active: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="587">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="588">
            

            

            <code class="ruby">    first_visit = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="589">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="590">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="591">
            

            

            <code class="ruby">      package: triple_pkg,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="592">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="593">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="594">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="595">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="596">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="597">
            

            

            <code class="ruby">      updater: @user,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="598">
            

            

            <code class="ruby">      skip_auto_series_creation: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="599">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="600">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="601">
            

            

            <code class="ruby">    # sanity check</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="602">
            

            

            <code class="ruby">    assert_equal &quot;pending_patient_approval&quot;, first_visit.status</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="603">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="604">
            

            

            <code class="ruby">    # update the series appointment to pending patient approval as well</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="605">
            

            

            <code class="ruby">    child = first_visit.series_appointments.order(:visit_number).first</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="606">
            

            

            <code class="ruby">    child.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="607">
            

            

            <code class="ruby">      status: :pending_patient_approval,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="608">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="609">
            

            

            <code class="ruby">      appointment_date_time: 4.days.from_now.change(hour: 10),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="610">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="611">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="612">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="613">
            

            

            <code class="ruby">    # Try to reschedule the first visit *after* its series visit</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="614">
            

            

            <code class="ruby">    first_visit.appointment_date_time = 5.days.from_now.change(hour: 11)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="615">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="616">
            

            

            <code class="ruby">    assert_not first_visit.valid?, &quot;validation should fail when first visit is moved beyond a series visit&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="617">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="618">
            

            

            <code class="ruby">    # Error must reference the offending child appointment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="619">
            

            

            <code class="ruby">    msg = first_visit.errors[:appointment_date_time].join</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="620">
            

            

            <code class="ruby">    assert_includes msg, &quot;must occur before any another visit series (#{child.registration_number})&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="621">
            

            

            <code class="ruby">      &quot;message should mention the child registration number&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="622">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="623">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="624">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;formatted_discount and formatted_total_price work as expected, about formatted_discount and formatted_total_price&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="625">
            

            

            <code class="ruby">    appt = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="626">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="627">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="628">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="629">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="630">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="631">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="632">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="633">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="634">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="635">
            

            

            <code class="ruby">    assert_equal &quot;IDR 100,000.00&quot;, appt.formatted_total_price</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="636">
            

            

            <code class="ruby">    assert_equal &quot;IDR 0.00&quot;, appt.formatted_discount</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="637">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="638">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="639">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;visit_progress returns visit number out of total, about visit_progress&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="640">
            

            

            <code class="ruby">    appt = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="641">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="642">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="643">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="644">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="645">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="646">
            

            

            <code class="ruby">      visit_number: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="647">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="648">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="649">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="650">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="651">
            

            

            <code class="ruby">    assert_equal &quot;1/1&quot;, appt.visit_progress</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="652">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="653">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="654">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;series_completion returns completed visits over total, about series_completion&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="655">
            

            

            <code class="ruby">    pkg = Package.create!(service: @service, name: &quot;Series&quot;, number_of_visit: 3, currency: &quot;IDR&quot;, price_per_visit: 1, total_price: 3, fee_per_visit: 1, total_fee: 3, active: true)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="656">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="657">
            

            

            <code class="ruby">    initial = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="658">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="659">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="660">
            

            

            <code class="ruby">      package: pkg,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="661">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="662">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="663">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="664">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="665">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="666">
            

            

            <code class="ruby">    assert_equal &quot;0/2&quot;, initial.series_completion</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="667">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="668">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="669">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;next_available_visit_number returns next number if valid, about next_available_visit_number&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="670">
            

            

            <code class="ruby">    pkg = Package.create!(service: @service, name: &quot;Series&quot;, number_of_visit: 3, currency: &quot;IDR&quot;, price_per_visit: 1, total_price: 3, fee_per_visit: 1, total_fee: 3, active: true)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="671">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="672">
            

            

            <code class="ruby">    initial = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="673">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="674">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="675">
            

            

            <code class="ruby">      package: pkg,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="676">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="677">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="678">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="679">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="680">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="681">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="682">
            

            

            <code class="ruby">    assert_equal 2, initial.next_available_visit_number</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="683">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="684">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="685">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;next_visit_progress returns correct format or nil, about next_visit_progress&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="686">
            

            

            <code class="ruby">    pkg = Package.create!(service: @service, name: &quot;Series&quot;, number_of_visit: 3, currency: &quot;IDR&quot;, price_per_visit: 1, total_price: 3, fee_per_visit: 1, total_fee: 3, active: true)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="687">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="688">
            

            

            <code class="ruby">    initial = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="689">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="690">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="691">
            

            

            <code class="ruby">      package: pkg,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="692">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="693">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="694">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="695">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="696">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="697">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="698">
            

            

            <code class="ruby">    assert_equal &quot;2/3&quot;, initial.next_visit_progress</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="699">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="700">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="701">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;needs_scheduling? returns true only when unscheduled with no date, about needs_scheduling?&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="702">
            

            

            <code class="ruby">    appt = Appointment.new(status: :unscheduled, appointment_date_time: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="703">
            

            

            <code class="ruby">    assert appt.needs_scheduling?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="704">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="705">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="706">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;series_available? returns true when package has multiple visits, about series_available?&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="707">
            

            

            <code class="ruby">    pkg = Package.new(number_of_visit: 3)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="708">
            

            

            <code class="ruby">    appt = Appointment.new(package: pkg)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="709">
            

            

            <code class="ruby">    assert appt.series_available?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="710">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="711">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="712">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;status_human_readable returns correct hash, about status_human_readable&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="713">
            

            

            <code class="ruby">    appt = Appointment.new(status: :paid)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="714">
            

            

            <code class="ruby">    assert_equal &quot;Confirmed&quot;, appt.status_human_readable[:name]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="715">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="716">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="717">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;all_visits_in_series returns full set sorted, about all_visits_in_series&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="718">
            

            

            <code class="ruby">    triple_pkg = Package.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="719">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="720">
            

            

            <code class="ruby">      name: &quot;Series3&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="721">
            

            

            <code class="ruby">      number_of_visit: 3,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="722">
            

            

            <code class="ruby">      currency: &quot;IDR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="723">
            

            

            <code class="ruby">      price_per_visit: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="724">
            

            

            <code class="ruby">      total_price: 3,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="725">
            

            

            <code class="ruby">      fee_per_visit: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="726">
            

            

            <code class="ruby">      total_fee: 3,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="727">
            

            

            <code class="ruby">      active: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="728">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="729">
            

            

            <code class="ruby">    initial = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="730">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="731">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="732">
            

            

            <code class="ruby">      package: triple_pkg,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="733">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="734">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="735">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="736">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="737">
            

            

            <code class="ruby">      skip_auto_series_creation: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="738">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="739">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="740">
            

            

            <code class="ruby">    all_visits = initial.all_visits_in_series</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="741">
            

            

            <code class="ruby">    assert_equal 3, all_visits.length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="742">
            

            

            <code class="ruby">    assert_equal 1, all_visits.first.visit_number</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="743">
            

            

            <code class="ruby">    assert_equal [2, 3], all_visits.drop(1).map(&amp;:visit_number)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="744">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="745">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="746">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;cancellable? returns true for initial or if parent cancelled, about cancellable?&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="747">
            

            

            <code class="ruby">    appt = Appointment.new(visit_number: 1)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="748">
            

            

            <code class="ruby">    assert appt.initial_visit?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="749">
            

            

            <code class="ruby">    assert appt.cancellable?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="750">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="751">
            

            

            <code class="ruby">    parent = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="752">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="753">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="754">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="755">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="756">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="757">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="758">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="759">
            

            

            <code class="ruby">    parent.cancel!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="760">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="761">
            

            

            <code class="ruby">    series = Appointment.new(reference_appointment: parent, visit_number: 2)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="762">
            

            

            <code class="ruby">    assert series.cancellable?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="763">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="764">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="765">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;patient_approve! updates status and records history&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="766">
            

            

            <code class="ruby">    appt = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="767">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="768">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="769">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="770">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="771">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="772">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="773">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="774">
            

            

            <code class="ruby">      updater: @user,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="775">
            

            

            <code class="ruby">      status_reason: &quot;Patient agreed&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="776">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="777">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="778">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="779">
            

            

            <code class="ruby">    assert appt.patient_approve!</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="780">
            

            

            <code class="ruby">    assert_equal &quot;pending_payment&quot;, appt.reload.status</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="781">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="782">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="783">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;mark_paid! updates status and records history&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="784">
            

            

            <code class="ruby">    appt = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="785">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="786">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="787">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="788">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="789">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="790">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="791">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="792">
            

            

            <code class="ruby">      updater: @user,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="793">
            

            

            <code class="ruby">      status_reason: &quot;Paid by QRIS&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="794">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="795">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="796">
            

            

            <code class="ruby">    appt.patient_approve!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="797">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="798">
            

            

            <code class="ruby">    assert appt.mark_paid!</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="799">
            

            

            <code class="ruby">    assert_equal &quot;paid&quot;, appt.reload.status</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="800">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="801">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="802">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;series appointment must match package and patient of reference, about validate_series_requirements&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="803">
            

            

            <code class="ruby">    initial = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="804">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="805">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="806">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="807">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="808">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="809">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="810">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="811">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="812">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="813">
            

            

            <code class="ruby">    # Different package &amp; patient</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="814">
            

            

            <code class="ruby">    other_patient_contact = PatientContact.create!(contact_name: &quot;Other&quot;, contact_phone: &quot;62891721231&quot;, email: &quot;other@yopmail.com&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="815">
            

            

            <code class="ruby">    other_patient = Patient.create!(name: &quot;Other&quot;, date_of_birth: &quot;2000-01-01&quot;, gender: &quot;FEMALE&quot;, patient_contact: other_patient_contact)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="816">
            

            

            <code class="ruby">    other_package = Package.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="817">
            

            

            <code class="ruby">      service: @service, name: &quot;Different&quot;, currency: &quot;IDR&quot;, number_of_visit: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="818">
            

            

            <code class="ruby">      price_per_visit: 100_000, total_price: 100_000, fee_per_visit: 70_000, total_fee: 70_000, active: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="819">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="820">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="821">
            

            

            <code class="ruby">    series = Appointment.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="822">
            

            

            <code class="ruby">      reference_appointment: initial,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="823">
            

            

            <code class="ruby">      patient: other_patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="824">
            

            

            <code class="ruby">      package: other_package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="825">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="826">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="827">
            

            

            <code class="ruby">      visit_number: 2,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="828">
            

            

            <code class="ruby">      appointment_date_time: @future_time + 1.day,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="829">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="830">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="831">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="832">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="833">
            

            

            <code class="ruby">    assert_not series.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="834">
            

            

            <code class="ruby">    assert_includes series.errors[:package_id], &quot;must match reference appointment&#39;s package&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="835">
            

            

            <code class="ruby">    assert_includes series.errors[:patient_id], &quot;must match reference appointment&#39;s patient&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="836">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="837">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="838">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;unscheduled appointment must not have therapist or appointment_date_time, about unscheduled_appointment_requirements&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="839">
            

            

            <code class="ruby">    triple_pkg = Package.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="840">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="841">
            

            

            <code class="ruby">      name: &quot;3-Visit Bundle&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="842">
            

            

            <code class="ruby">      currency: &quot;IDR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="843">
            

            

            <code class="ruby">      number_of_visit: 3,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="844">
            

            

            <code class="ruby">      price_per_visit: 100_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="845">
            

            

            <code class="ruby">      total_price: 300_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="846">
            

            

            <code class="ruby">      fee_per_visit: 70_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="847">
            

            

            <code class="ruby">      total_fee: 210_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="848">
            

            

            <code class="ruby">      active: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="849">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="850">
            

            

            <code class="ruby">    first_visit = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="851">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="852">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="853">
            

            

            <code class="ruby">      package: triple_pkg,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="854">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="855">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="856">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="857">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="858">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="859">
            

            

            <code class="ruby">      updater: @user,           # &lt;- will be copied to histories</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="860">
            

            

            <code class="ruby">      skip_auto_series_creation: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="861">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="862">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="863">
            

            

            <code class="ruby">    # sanity check</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="864">
            

            

            <code class="ruby">    assert_equal &quot;pending_patient_approval&quot;, first_visit.status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="865">
            

            

            <code class="ruby">    child = first_visit.series_appointments.order(:visit_number).first</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="866">
            

            

            <code class="ruby">    child.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="867">
            

            

            <code class="ruby">      status: :pending_patient_approval,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="868">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="869">
            

            

            <code class="ruby">      appointment_date_time: 4.days.from_now.change(hour: 10),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="870">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="871">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="872">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="873">
            

            

            <code class="ruby">    # Now make it invalid by assigning status :unscheduled but keeping the other fields</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="874">
            

            

            <code class="ruby">    child.assign_attributes(status: :unscheduled)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="875">
            

            

            <code class="ruby">    assert_not child.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="876">
            

            

            <code class="ruby">    assert_includes child.errors[:appointment_date_time], &quot;must be blank for unscheduled appointments&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="877">
            

            

            <code class="ruby">    assert_includes child.errors[:therapist_id], &quot;cannot be assigned to unscheduled appointments&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="878">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="879">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="880">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;blocks invalid status transitions for non-superadmin users, about valid_status_transition edge case&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="881">
            

            

            <code class="ruby">    appt = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="882">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="883">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="884">
            

            

            <code class="ruby">      package: @package,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="885">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="886">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="887">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="888">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="889">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="890">
            

            

            <code class="ruby">    # Try jumping to &quot;paid&quot; from pending_therapist_assignment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="891">
            

            

            <code class="ruby">    appt.status = &quot;paid&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="892">
            

            

            <code class="ruby">    appt.valid?  # should trigger validation</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="893">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="894">
            

            

            <code class="ruby">    assert_includes appt.errors[:status], &quot;invalid transition from Awaiting Therapist to Confirmed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="895">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="896">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="897">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;valid_for_scheduling? returns true only when time and therapist present, about valid_for_scheduling?&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="898">
            

            

            <code class="ruby">    appt = Appointment.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="899">
            

            

            <code class="ruby">    assert_not appt.send(:valid_for_scheduling?)  # should be private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="900">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="901">
            

            

            <code class="ruby">    appt.therapist = @therapist</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="902">
            

            

            <code class="ruby">    assert_not appt.send(:valid_for_scheduling?)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="903">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="904">
            

            

            <code class="ruby">    appt.appointment_date_time = @future_time</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="905">
            

            

            <code class="ruby">    assert appt.send(:valid_for_scheduling?)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="906">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="907">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="908">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;next_visits returns the next visit in series, about next_visits&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="909">
            

            

            <code class="ruby">    pkg = Package.create!(service: @service, name: &quot;Series&quot;, number_of_visit: 3, currency: &quot;IDR&quot;, price_per_visit: 1, total_price: 3, fee_per_visit: 1, total_fee: 3, active: true)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="910">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="911">
            

            

            <code class="ruby">    first = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="912">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="913">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="914">
            

            

            <code class="ruby">      package: pkg,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="915">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="916">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="917">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="918">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="919">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="920">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="921">
            

            

            <code class="ruby">    second = first.series_appointments.find_by(visit_number: 2)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="922">
            

            

            <code class="ruby">    assert_nil second</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="923">
            

            

            <code class="ruby">    assert_nil first.next_visits</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="924">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="925">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="926">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;series visit must be after initial and before next, about validate_series_visit_position&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="927">
            

            

            <code class="ruby">    triple_pkg = Package.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="928">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="929">
            

            

            <code class="ruby">      name: &quot;3-Visit Bundle&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="930">
            

            

            <code class="ruby">      currency: &quot;IDR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="931">
            

            

            <code class="ruby">      number_of_visit: 3,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="932">
            

            

            <code class="ruby">      price_per_visit: 100_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="933">
            

            

            <code class="ruby">      total_price: 300_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="934">
            

            

            <code class="ruby">      fee_per_visit: 70_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="935">
            

            

            <code class="ruby">      total_fee: 210_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="936">
            

            

            <code class="ruby">      active: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="937">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="938">
            

            

            <code class="ruby">    initial = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="939">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="940">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="941">
            

            

            <code class="ruby">      package: triple_pkg,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="942">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="943">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="944">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="945">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="946">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="947">
            

            

            <code class="ruby">      skip_auto_series_creation: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="948">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="949">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="950">
            

            

            <code class="ruby">    # manually schedule 3rd visit</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="951">
            

            

            <code class="ruby">    third = initial.series_appointments.find_by(visit_number: 3)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="952">
            

            

            <code class="ruby">    third.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="953">
            

            

            <code class="ruby">      appointment_date_time: @future_time + 5.days,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="954">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="955">
            

            

            <code class="ruby">      status: :pending_patient_approval,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="956">
            

            

            <code class="ruby">      status_reason: &quot;reschedule&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="957">
            

            

            <code class="ruby">      updater: @user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="958">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="959">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="960">
            

            

            <code class="ruby">    # set 2nd visit after 3rd  should be invalid</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="961">
            

            

            <code class="ruby">    second = initial.series_appointments.find_by(visit_number: 2)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="962">
            

            

            <code class="ruby">    second.appointment_date_time = @future_time + 6.days</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="963">
            

            

            <code class="ruby">    second.therapist = @therapist</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="964">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="965">
            

            

            <code class="ruby">    assert_not second.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="966">
            

            

            <code class="ruby">    assert_includes second.errors[:appointment_date_time].join, &quot;must be before visit 3&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="967">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="968">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="969">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;min_datetime and max_datetime return correct bounds for series visits, about min_datetime and max_datetime&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="970">
            

            

            <code class="ruby">    #  Setup a 3-visit package </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="971">
            

            

            <code class="ruby">    triple_pkg = Package.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="972">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="973">
            

            

            <code class="ruby">      name: &quot;3-Visit Series&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="974">
            

            

            <code class="ruby">      currency: &quot;IDR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="975">
            

            

            <code class="ruby">      number_of_visit: 3,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="976">
            

            

            <code class="ruby">      price_per_visit: 100_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="977">
            

            

            <code class="ruby">      total_price: 300_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="978">
            

            

            <code class="ruby">      fee_per_visit: 70_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="979">
            

            

            <code class="ruby">      total_fee: 210_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="980">
            

            

            <code class="ruby">      active: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="981">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="982">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="983">
            

            

            <code class="ruby">    #  Create the FIRST visit at a known time </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="984">
            

            

            <code class="ruby">    t0 = @future_time.change(hour: 9)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="985">
            

            

            <code class="ruby">    first = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="986">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="987">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="988">
            

            

            <code class="ruby">      package: triple_pkg,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="989">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="990">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="991">
            

            

            <code class="ruby">      appointment_date_time: t0,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="992">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="993">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="994">
            

            

            <code class="ruby">      skip_auto_series_creation: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="995">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="996">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="997">
            

            

            <code class="ruby">    #  Grab the auto-built series appointments </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="998">
            

            

            <code class="ruby">    second = first.series_appointments.find_by(visit_number: 2)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="999">
            

            

            <code class="ruby">    third = first.series_appointments.find_by(visit_number: 3)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1000">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1001">
            

            

            <code class="ruby">    #  Schedule them at t1 = t0 + 1.day, t2 = t0 + 2.days </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1002">
            

            

            <code class="ruby">    t1 = t0 + 1.day</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1003">
            

            

            <code class="ruby">    t2 = t0 + 2.days</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1004">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1005">
            

            

            <code class="ruby">    [second, third].each do |appt|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1006">
            

            

            <code class="ruby">      appt.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1007">
            

            

            <code class="ruby">        therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1008">
            

            

            <code class="ruby">        appointment_date_time: ((appt.visit_number == 2) ? t1 : t2),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1009">
            

            

            <code class="ruby">        status: :pending_patient_approval,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1010">
            

            

            <code class="ruby">        preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1011">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1012">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1013">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1014">
            

            

            <code class="ruby">    #  Assertions for the model helpers </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1015">
            

            

            <code class="ruby">    # First visit: no previous, next is the 2nd</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1016">
            

            

            <code class="ruby">    assert_nil first.min_datetime</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1017">
            

            

            <code class="ruby">    assert_equal t1, first.max_datetime</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1018">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1019">
            

            

            <code class="ruby">    # Second visit: prev is first, next is third</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1020">
            

            

            <code class="ruby">    assert_equal t0, second.min_datetime</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1021">
            

            

            <code class="ruby">    assert_equal t2, second.max_datetime</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1022">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1023">
            

            

            <code class="ruby">    # Third visit: prev is second, no next</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1024">
            

            

            <code class="ruby">    assert_equal t1, third.min_datetime</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1025">
            

            

            <code class="ruby">    assert_nil third.max_datetime</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1026">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1027">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1028">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;hold! puts a series appointment on hold and cascades to other appointments in series&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1029">
            

            

            <code class="ruby">    # Create a package with multiple visits</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1030">
            

            

            <code class="ruby">    triple_pkg = Package.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1031">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1032">
            

            

            <code class="ruby">      name: &quot;3-Visit Bundle&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1033">
            

            

            <code class="ruby">      number_of_visit: 3,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1034">
            

            

            <code class="ruby">      currency: &quot;IDR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1035">
            

            

            <code class="ruby">      price_per_visit: 100_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1036">
            

            

            <code class="ruby">      total_price: 300_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1037">
            

            

            <code class="ruby">      fee_per_visit: 70_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1038">
            

            

            <code class="ruby">      total_fee: 210_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1039">
            

            

            <code class="ruby">      active: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1040">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1041">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1042">
            

            

            <code class="ruby">    # Create an initial appointment with auto-created series</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1043">
            

            

            <code class="ruby">    initial = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1044">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1045">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1046">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1047">
            

            

            <code class="ruby">      package: triple_pkg,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1048">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1049">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1050">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1051">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1052">
            

            

            <code class="ruby">      updater: @user,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1053">
            

            

            <code class="ruby">      skip_auto_series_creation: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1054">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1055">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1056">
            

            

            <code class="ruby">    # Ensure series appointments were created</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1057">
            

            

            <code class="ruby">    series_appointments = initial.series_appointments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1058">
            

            

            <code class="ruby">    assert_equal 2, series_appointments.count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1059">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1060">
            

            

            <code class="ruby">    # Schedule the second appointment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1061">
            

            

            <code class="ruby">    second_appt = series_appointments.find_by(visit_number: 2)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1062">
            

            

            <code class="ruby">    second_appt.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1063">
            

            

            <code class="ruby">      appointment_date_time: @future_time + 1.week,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1064">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1065">
            

            

            <code class="ruby">      status: :pending_patient_approval</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1066">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1067">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1068">
            

            

            <code class="ruby">    # Put the second appointment on hold</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1069">
            

            

            <code class="ruby">    assert second_appt.hold!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1070">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1071">
            

            

            <code class="ruby">    # Verify the second appointment is on hold and details are cleared</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1072">
            

            

            <code class="ruby">    second_appt.reload</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1073">
            

            

            <code class="ruby">    assert_equal &quot;on_hold&quot;, second_appt.status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1074">
            

            

            <code class="ruby">    assert_nil second_appt.appointment_date_time</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1075">
            

            

            <code class="ruby">    assert_nil second_appt.therapist_id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1076">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1077">
            

            

            <code class="ruby">    # Verify the third appointment is also on hold</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1078">
            

            

            <code class="ruby">    third_appt = series_appointments.find_by(visit_number: 3)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1079">
            

            

            <code class="ruby">    third_appt.reload</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1080">
            

            

            <code class="ruby">    assert_equal &quot;on_hold&quot;, third_appt.status</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1081">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1082">
            

            

            <code class="ruby">    # Verify the initial appointment is NOT on hold (remains in its original status)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1083">
            

            

            <code class="ruby">    initial.reload</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1084">
            

            

            <code class="ruby">    assert_not_equal &quot;on_hold&quot;, initial.status</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1085">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1086">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1087">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;cascade_hold only affects series visits with visit_number &gt; 1 and not paid status&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1088">
            

            

            <code class="ruby">    # Create a package with 3 visits</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1089">
            

            

            <code class="ruby">    triple_pkg = Package.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1090">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1091">
            

            

            <code class="ruby">      name: &quot;3-Visit Bundle&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1092">
            

            

            <code class="ruby">      currency: &quot;IDR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1093">
            

            

            <code class="ruby">      number_of_visit: 3,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1094">
            

            

            <code class="ruby">      price_per_visit: 100_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1095">
            

            

            <code class="ruby">      total_price: 300_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1096">
            

            

            <code class="ruby">      fee_per_visit: 70_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1097">
            

            

            <code class="ruby">      total_fee: 210_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1098">
            

            

            <code class="ruby">      active: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1099">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1100">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1101">
            

            

            <code class="ruby">    # Create initial visit</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1102">
            

            

            <code class="ruby">    first_visit = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1103">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1104">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1105">
            

            

            <code class="ruby">      package: triple_pkg,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1106">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1107">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1108">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1109">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1110">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1111">
            

            

            <code class="ruby">      updater: @user,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1112">
            

            

            <code class="ruby">      skip_auto_series_creation: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1113">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1114">
            

            

            <code class="ruby">    first_visit.update!(status: :pending_payment)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1115">
            

            

            <code class="ruby">    first_visit.update!(status: :paid)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1116">
            

            

            <code class="ruby">    first_visit.update!(status: :completed)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1117">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1118">
            

            

            <code class="ruby">    # Get series visits</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1119">
            

            

            <code class="ruby">    second_visit = first_visit.series_appointments.find_by(visit_number: 2)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1120">
            

            

            <code class="ruby">    third_visit = first_visit.series_appointments.find_by(visit_number: 3)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1121">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1122">
            

            

            <code class="ruby">    # Set up the second visit as completed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1123">
            

            

            <code class="ruby">    second_visit.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1124">
            

            

            <code class="ruby">      status: :pending_patient_approval,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1125">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1126">
            

            

            <code class="ruby">      appointment_date_time: @future_time + 2.days,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1127">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1128">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1129">
            

            

            <code class="ruby">    second_visit.update!(status: :pending_payment)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1130">
            

            

            <code class="ruby">    second_visit.update!(status: :paid)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1131">
            

            

            <code class="ruby">    second_visit.update!(status: :completed)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1132">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1133">
            

            

            <code class="ruby">    # Set up the third visit as pending</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1134">
            

            

            <code class="ruby">    third_visit.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1135">
            

            

            <code class="ruby">      status: :pending_patient_approval,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1136">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1137">
            

            

            <code class="ruby">      appointment_date_time: @future_time + 4.days,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1138">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1139">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1140">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1141">
            

            

            <code class="ruby">    # Put hold from first visit which should change on hold to all non-paid series visits</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1142">
            

            

            <code class="ruby">    first_visit.hold!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1143">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1144">
            

            

            <code class="ruby">    # Reload all appointments to get updated statuses</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1145">
            

            

            <code class="ruby">    first_visit.reload</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1146">
            

            

            <code class="ruby">    second_visit.reload</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1147">
            

            

            <code class="ruby">    third_visit.reload</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1148">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1149">
            

            

            <code class="ruby">    # First visit should remain on hold</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1150">
            

            

            <code class="ruby">    assert_equal &quot;completed&quot;, first_visit.status, &quot;First visit should remain completed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1151">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1152">
            

            

            <code class="ruby">    # Second visit should remain paid (not affected by cascade)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1153">
            

            

            <code class="ruby">    assert_equal &quot;completed&quot;, second_visit.status, &quot;Second visit should remain completed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1154">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1155">
            

            

            <code class="ruby">    # Third visit should be changed to on hold</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1156">
            

            

            <code class="ruby">    assert_equal &quot;on_hold&quot;, third_visit.status, &quot;Third visit should be changed to on hold&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1157">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1158">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1159">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;on_hold appointments have their appointment_date_time and therapist_id cleared&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1160">
            

            

            <code class="ruby">    # Create a package with multiple visits</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1161">
            

            

            <code class="ruby">    triple_pkg = Package.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1162">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1163">
            

            

            <code class="ruby">      name: &quot;3-Visit Bundle&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1164">
            

            

            <code class="ruby">      number_of_visit: 3,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1165">
            

            

            <code class="ruby">      currency: &quot;IDR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1166">
            

            

            <code class="ruby">      price_per_visit: 100_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1167">
            

            

            <code class="ruby">      total_price: 300_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1168">
            

            

            <code class="ruby">      fee_per_visit: 70_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1169">
            

            

            <code class="ruby">      total_fee: 210_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1170">
            

            

            <code class="ruby">      active: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1171">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1172">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1173">
            

            

            <code class="ruby">    # Create an initial appointment with auto-created series</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1174">
            

            

            <code class="ruby">    initial = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1175">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1176">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1177">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1178">
            

            

            <code class="ruby">      package: triple_pkg,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1179">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1180">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1181">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1182">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1183">
            

            

            <code class="ruby">      updater: @user,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1184">
            

            

            <code class="ruby">      skip_auto_series_creation: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1185">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1186">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1187">
            

            

            <code class="ruby">    # Schedule the second appointment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1188">
            

            

            <code class="ruby">    second_appt = initial.series_appointments.find_by(visit_number: 2)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1189">
            

            

            <code class="ruby">    second_appt.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1190">
            

            

            <code class="ruby">      appointment_date_time: @future_time + 1.week,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1191">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1192">
            

            

            <code class="ruby">      status: :pending_patient_approval</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1193">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1194">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1195">
            

            

            <code class="ruby">    # Verify it has appointment_date_time and therapist_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1196">
            

            

            <code class="ruby">    assert_not_nil second_appt.appointment_date_time</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1197">
            

            

            <code class="ruby">    assert_not_nil second_appt.therapist_id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1198">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1199">
            

            

            <code class="ruby">    # Update status to on_hold directly</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1200">
            

            

            <code class="ruby">    second_appt.update(status: :on_hold)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1201">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1202">
            

            

            <code class="ruby">    # Verify appointment_date_time and therapist_id are cleared</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1203">
            

            

            <code class="ruby">    second_appt.reload</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1204">
            

            

            <code class="ruby">    assert_nil second_appt.appointment_date_time</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1205">
            

            

            <code class="ruby">    assert_nil second_appt.therapist_id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1206">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1207">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1208">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;unscheduled appointments can be put on hold&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1209">
            

            

            <code class="ruby">    # Create a package with multiple visits</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1210">
            

            

            <code class="ruby">    triple_pkg = Package.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1211">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1212">
            

            

            <code class="ruby">      name: &quot;3-Visit Bundle&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1213">
            

            

            <code class="ruby">      number_of_visit: 3,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1214">
            

            

            <code class="ruby">      currency: &quot;IDR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1215">
            

            

            <code class="ruby">      price_per_visit: 100_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1216">
            

            

            <code class="ruby">      total_price: 300_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1217">
            

            

            <code class="ruby">      fee_per_visit: 70_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1218">
            

            

            <code class="ruby">      total_fee: 210_000,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1219">
            

            

            <code class="ruby">      active: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1220">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1221">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1222">
            

            

            <code class="ruby">    # Create an initial appointment with auto-created series</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1223">
            

            

            <code class="ruby">    initial = Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1224">
            

            

            <code class="ruby">      patient: @patient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1225">
            

            

            <code class="ruby">      service: @service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1226">
            

            

            <code class="ruby">      package: triple_pkg,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1227">
            

            

            <code class="ruby">      location: @location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1228">
            

            

            <code class="ruby">      appointment_date_time: @future_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1229">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1230">
            

            

            <code class="ruby">      patient_medical_record_attributes: @patient_medical_record,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1231">
            

            

            <code class="ruby">      updater: @user,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1232">
            

            

            <code class="ruby">      skip_auto_series_creation: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1233">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1234">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1235">
            

            

            <code class="ruby">    # Get the third appointment (which should be unscheduled)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1236">
            

            

            <code class="ruby">    third_appt = initial.series_appointments.find_by(visit_number: 3)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1237">
            

            

            <code class="ruby">    assert_equal &quot;unscheduled&quot;, third_appt.status</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1238">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1239">
            

            

            <code class="ruby">    # Put it on hold</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1240">
            

            

            <code class="ruby">    assert third_appt.hold!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1241">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1242">
            

            

            <code class="ruby">    # Verify it&#39;s now on hold</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1243">
            

            

            <code class="ruby">    third_appt.reload</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1244">
            

            

            <code class="ruby">    assert_equal &quot;on_hold&quot;, third_appt.status</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1245">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1246">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="07ab8efcc9b4547e6f447e2ec13dbc08d89c723d">
  <div class="header">
    <h3>test/models/bank_detail_test.rb</h3>
    <h4>
      <span class="red">
  32.26%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>31</b> relevant lines.
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>21</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class BankDetailTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def setup</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @bca_1 = bank_details(:bca_1)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @mandiri_1 = bank_details(:mandiri_1)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  # Test validations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;valid bank detail should be valid&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    assert @bca_1.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;bank detail should validate presence of bank_name&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    @bca_1.bank_name = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    assert_not @bca_1.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    assert_includes @bca_1.errors[:bank_name], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="20">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;bank detail should validate presence of account_number&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    @bca_1.account_number = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    assert_not @bca_1.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    assert_includes @bca_1.errors[:account_number], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="26">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;bank detail should validate presence of account_holder_name&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    @bca_1.account_holder_name = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    assert_not @bca_1.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    assert_includes @bca_1.errors[:account_holder_name], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="32">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;bank detail should validate uniqueness of account_number scoped to bank_name&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">    duplicate = BankDetail.new(bank_name: @bca_1.bank_name, account_number: @bca_1.account_number, account_holder_name: &quot;Test User&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    assert_not duplicate.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    assert_includes duplicate.errors[:account_number], &quot;The combination of bank name and account number must be unique&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">  # Test callbacks</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="39">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;uppercase_bank_name_and_account_holder_name should transform to uppercase&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    @mandiri_1.bank_name = &quot;mandiri&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    @mandiri_1.account_holder_name = &quot;Therapist Two&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    @mandiri_1.save!</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">    assert_equal &quot;MANDIRI&quot;, @mandiri_1.bank_name</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">    assert_equal &quot;THERAPIST TWO&quot;, @mandiri_1.account_holder_name</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">  # Test associations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="48">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should have many therapists through therapist_bank_details&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    assert_includes @bca_1.therapists, therapists(:therapist_one)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="09a76f0c05c55fd6238e87fe6e90c4f9a559313a">
  <div class="header">
    <h3>test/models/indonesian_area_test.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class IndonesianAreaTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # test &quot;the truth&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  #   assert true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="2826d709be9f9724bd38712f9ba69c37530432dc">
  <div class="header">
    <h3>test/models/location_service_test.rb</h3>
    <h4>
      <span class="red">
  43.75%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>16</b> relevant lines.
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class LocationServiceTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def setup</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @jakarta_selatan_fisiohome = location_services(:jakarta_selatan_fisiohome)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @bandung_fisiohome = location_services(:bandung_fisiohome)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  # Test validations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;valid location_service should be valid&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    assert @jakarta_selatan_fisiohome.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    assert @bandung_fisiohome.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;location_service should validate uniqueness of location-service combination&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    duplicate_location_service = LocationService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">      location: @jakarta_selatan_fisiohome.location,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">      service: @jakarta_selatan_fisiohome.service,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">      active: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    assert_not duplicate_location_service.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    assert_includes duplicate_location_service.errors[:location_id], &quot;has already been taken&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">  # Test associations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="26">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should belong to a location&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    assert_equal locations(:jakarta_selatan), @jakarta_selatan_fisiohome.location</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="30">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should belong to a service&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    assert_equal services(:fisiohome), @jakarta_selatan_fisiohome.service</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="74cf60cabb5e1114974e5ffd41e8cdc2965748eb">
  <div class="header">
    <h3>test/models/location_test.rb</h3>
    <h4>
      <span class="red">
  36.36%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>33</b> relevant lines.
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>21</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class LocationTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def setup</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @jakarta_selatan = locations(:jakarta_selatan)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @bandung = locations(:bandung)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  # Test validations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;valid location should be valid&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    assert @jakarta_selatan.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    assert @bandung.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;location should validate presence of country&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    @jakarta_selatan.country = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    assert_not @jakarta_selatan.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    assert_includes @jakarta_selatan.errors[:country], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="21">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;location should validate presence of state&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    @jakarta_selatan.state = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    assert_not @jakarta_selatan.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    assert_includes @jakarta_selatan.errors[:state], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="27">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;location should validate presence of city&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    @jakarta_selatan.city = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    assert_not @jakarta_selatan.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    assert_includes @jakarta_selatan.errors[:city], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="33">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;location should validate uniqueness of city&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    duplicate_location = Location.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">      country: @jakarta_selatan.country,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">      country_code: @jakarta_selatan.country_code,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">      state: @jakarta_selatan.state,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">      city: @jakarta_selatan.city</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    assert_not duplicate_location.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    assert_includes duplicate_location.errors[:city], &quot;has already been taken&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">  # Test associations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="45">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should have many addresses&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">    assert_includes @jakarta_selatan.addresses, addresses(:jakarta_selatan_address)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="49">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should have many location_services&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">    assert_includes @jakarta_selatan.location_services, location_services(:jakarta_selatan_fisiohome)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="53">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should have many services through location_services&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">    assert_includes @jakarta_selatan.services, services(:fisiohome)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="57">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should have one active service&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">    active_service = @jakarta_selatan.active_services</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">    assert_equal location_services(:jakarta_selatan_fisiohome), active_service</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="3c921bd0aa91713f4b3e31d21a17f2677e7aea9f">
  <div class="header">
    <h3>test/models/package_test.rb</h3>
    <h4>
      <span class="red">
  30.19%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>53</b> relevant lines.
      <span class="green"><b>16</b> lines covered</span> and
      <span class="red"><b>37</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class PackageTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  setup do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @package = packages(:basic_fisiohome)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  # Test basic validity</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;valid package&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    assert @package.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  # Test presence validations with error messages</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;invalid without name&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    @package.name = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    assert_not @package.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    assert_includes @package.errors[:name], &quot;can&#39;t be blank&quot;, &quot;Name should have a presence validation error&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="20">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;invalid without currency&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    @package.currency = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    assert_not @package.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    assert_includes @package.errors[:currency], &quot;can&#39;t be blank&quot;, &quot;Currency should have a presence validation error&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="26">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;invalid without number_of_visit&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    @package.number_of_visit = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    assert_not @package.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    assert_includes @package.errors[:number_of_visit], &quot;can&#39;t be blank&quot;, &quot;Number of visits should have a presence validation error&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">  # Test numericality validations with error messages</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="33">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;invalid with negative number_of_visit&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    @package.number_of_visit = -1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    assert_not @package.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    assert_includes @package.errors[:number_of_visit], &quot;must be greater than 0&quot;, &quot;Number of visits should be greater than 0&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="39">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;invalid with negative price_per_visit&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    @package.price_per_visit = -10</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    assert_not @package.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    assert_includes @package.errors[:price_per_visit], &quot;must be greater than or equal to 0&quot;, &quot;Price per visit should be non-negative&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="45">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;total_price calculation&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">    package = Package.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">      service: services(:pusat_okupasi),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">      name: &quot;Test Package&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">      currency: &quot;USD&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">      number_of_visit: 5,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">      price_per_visit: 100,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">      discount: 50,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">      fee_per_visit: 10</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    package.valid? # Trigger callback</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">    assert_equal 450, package.total_price, &quot;Incorrect total_price calculation&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">    assert_equal 50, package.total_fee, &quot;Incorrect total_fee calculation&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="60">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;discount can be nil&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    @package.discount = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    assert @package.valid?, &quot;Package should be valid without a discount&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">  # Test associations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="66">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;belongs to service&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">    assert_respond_to @package, :service, &quot;Package should belong to a service&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">    assert_not_nil @package.service, &quot;Package&#39;s service should not be nil&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="71">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;invalid without service&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">    @package.service = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    assert_not @package.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">    assert_includes @package.errors[:service], &quot;must exist&quot;, &quot;Package should require a valid service association&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">  # Test formatted data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="78">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;formatted_price_per_visit returns formatted value&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">    @package.price_per_visit = 123.456</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">    @package.currency = &quot;USD&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">    expected_format = &quot;USD 123.46&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">    assert_equal expected_format, @package.formatted_price_per_visit, &quot;Price per visit should be formatted with currency and precision&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="85">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;formatted_total_price handles discount correctly&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">    package = packages(:zero_discount_package)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">    expected_format = &quot;USD 250.00&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">    assert_equal expected_format, package.formatted_total_price, &quot;Total price should be formatted and include zero discount&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="91">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;formatted_discount is nil when discount is nil&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">    @package.discount = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">    assert_nil @package.formatted_discount, &quot;Formatted discount should be nil when discount is nil&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ef434de5f23a850c7afbd65acf58a6764eb3ec80">
  <div class="header">
    <h3>test/models/patient_address_test.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class PatientAddressTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # test &quot;the truth&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  #   assert true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c94e692f298f172e69545c68de154faa554ffedd">
  <div class="header">
    <h3>test/models/patient_contact_test.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class PatientContactTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # test &quot;the truth&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  #   assert true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="66cba5048bf687945f971379156f43f77f6ea40b">
  <div class="header">
    <h3>test/models/patient_medical_record_test.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class PatientMedicalRecordTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # test &quot;the truth&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  #   assert true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="bc62a2a5107c74776e458987f949da98dbc4ee23">
  <div class="header">
    <h3>test/models/patient_test.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class PatientTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # test &quot;the truth&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  #   assert true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="db6c3fc04efc9a6d9b068ba508bec0c6df7c90da">
  <div class="header">
    <h3>test/models/service_test.rb</h3>
    <h4>
      <span class="red">
  27.91%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>43</b> relevant lines.
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>31</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class ServiceTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def setup</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @fisiohome_service = services(:fisiohome)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @pusat_okupasi_service = services(:pusat_okupasi)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    @caregiver = services(:caregiver)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  # Test validations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;valid service should be valid&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    assert @fisiohome_service.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;service should validate presence of name&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    @fisiohome_service.name = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    assert_not @fisiohome_service.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    assert_includes @fisiohome_service.errors[:name], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="21">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;service should validate presence of code&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    @fisiohome_service.code = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    assert_not @fisiohome_service.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    assert_includes @fisiohome_service.errors[:code], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="27">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;service should validate uniqueness of name&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    duplicate_service = Service.new(name: @fisiohome_service.name, code: &quot;NEW_CODE&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    assert_not duplicate_service.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    assert_includes duplicate_service.errors[:name], &quot;has already been taken&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">  # Test associations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="34">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should destroy associated location_services when service is destroyed&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    LocationService.create!(service: @caregiver, location: locations(:bandung_kab))</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    assert_difference &quot;LocationService.count&quot;, -1 do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">      @caregiver.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">  # Test cascading delete for packages</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="42">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should destroy associated packages when service is destroyed&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">    fisiohome_package = packages(:basic_fisiohome)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">    # -2 because in the packages.yml have 2 packages for fisiohome service</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">    assert_difference &quot;Package.count&quot;, -2 do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">      @fisiohome_service.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    assert_nil Package.find_by(id: fisiohome_package.id), &quot;Package  should be destroyed when associated service is destroyed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">  # Test callbacks</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="53">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;transform_service_name should convert name to uppercase and replace spaces with underscores&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">    @fisiohome_service.name = &quot;New Service Name&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    @fisiohome_service.save!</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">    assert_equal &quot;NEW_SERVICE_NAME&quot;, @fisiohome_service.name</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="59">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;transform_service_name should convert code to uppercase&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">    @fisiohome_service.code = &quot;lowercase_code&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    @fisiohome_service.save!</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    assert_equal &quot;LOWERCASE_CODE&quot;, @fisiohome_service.code</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">  # Test ActivationValidation (if `ActivationValidation` module adds behavior)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="66">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;activation module should allow service activation toggle&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">    assert_respond_to @fisiohome_service, :active?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">    @fisiohome_service.active = true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    assert @fisiohome_service.active?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">    @fisiohome_service.active = false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    assert_not @fisiohome_service.active?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="27f5cfa0c92c187ae91d9b0a665f8195dd61ce5e">
  <div class="header">
    <h3>test/models/therapist_address_test.rb</h3>
    <h4>
      <span class="red">
  46.67%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>15</b> relevant lines.
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class TherapistAddressTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def setup</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @therapist_one_addresses = therapist_addresses(:therapist_one_addresses)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @therapist_two_addresses = therapist_addresses(:therapist_two_addresses)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  # Test validations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should be valid with valid attributes&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    assert @therapist_one_addresses.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    assert @therapist_two_addresses.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">  # test &quot;should not allow more than one active address per therapist&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">  #   new_address = TherapistAddress.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">  #     therapist: therapists(:therapist_one),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">  #     address: addresses(:bandung_address),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  #     active: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">  #   )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  #   assert_not new_address.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">  #   assert_includes new_address.errors[:active], &quot;only one active address is allowed per therapist&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="25">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should allow multiple inactive addresses for the same therapist&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    inactive_address = TherapistAddress.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">      therapist: therapists(:therapist_one),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">      address: addresses(:bandung_address),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">      active: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    assert inactive_address.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">  # Test associations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="35">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should belong to a therapist&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    assert_equal therapists(:therapist_one), @therapist_one_addresses.therapist</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="39">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should belong to an address&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    assert_equal addresses(:jakarta_selatan_address), @therapist_one_addresses.address</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="fc67656cb640e13aacbd057d585abbd21466e768">
  <div class="header">
    <h3>test/models/therapist_adjusted_availability_test.rb</h3>
    <h4>
      <span class="red">
  20.9%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>67</b> relevant lines.
      <span class="green"><b>14</b> lines covered</span> and
      <span class="red"><b>53</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class TherapistAdjustedAvailabilityTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def setup</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">    # Suppose these fixture records exist in test/fixtures/therapist_adjusted_availabilities.yml</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @unavailable_entire_day = therapist_adjusted_availabilities(:unavailable_entire_day)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    @partial_one = therapist_adjusted_availabilities(:partial_availability_one)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    @partial_two = therapist_adjusted_availabilities(:partial_availability_two)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">    # A schedule that is NOT available_now, so it has a date window</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    @window_schedule = therapist_appointment_schedules(:window_schedule)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">    # A schedule that is available_now</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    @instant_schedule = therapist_appointment_schedules(:instant_schedule)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="16">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;fixtures are valid&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    assert @unavailable_entire_day.valid?, @unavailable_entire_day.errors.full_messages</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    assert @partial_one.valid?, @partial_one.errors.full_messages</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    assert @partial_two.valid?, @partial_two.errors.full_messages</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="22">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;must have a specific_date&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    @partial_one.specific_date = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    refute @partial_one.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    assert_includes @partial_one.errors[:specific_date], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="28">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;fully unavailable scenario (both times nil) is valid&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    assert @unavailable_entire_day.unavailable?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    assert @unavailable_entire_day.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="33">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;end_time must be after start_time if times are present&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    @partial_one.start_time = &quot;14:00&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    @partial_one.end_time = &quot;13:59&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    refute @partial_one.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    assert_includes @partial_one.errors[:end_time], &quot;must be after the start time&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="40">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;start_time and end_time must both be present or both absent&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">    # 1) One is present, the other absent =&gt; invalid</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    @partial_one.start_time = &quot;14:00&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">    @partial_one.end_time = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">    refute @partial_one.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">    assert_includes @partial_one.errors[:base], &quot;Start time and end time must both be present or both absent&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">    # 2) The opposite: end_time present, start_time absent =&gt; also invalid</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    @partial_one.start_time = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    @partial_one.end_time = &quot;14:00&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">    refute @partial_one.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">    assert_includes @partial_one.errors[:base], &quot;Start time and end time must both be present or both absent&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">    # 3) Both nil =&gt; valid if your logic allows a no time scenario</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">    @partial_one.start_time = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    @partial_one.end_time = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">    assert @partial_one.valid?, @partial_one.errors.full_messages</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">    # 4) Both present =&gt; valid</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">    @partial_one.start_time = &quot;09:00&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">    @partial_one.end_time = &quot;11:00&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    assert @partial_one.valid?, @partial_one.errors.full_messages</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="64">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;exact duplicate record is invalid&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">    duplicate = TherapistAdjustedAvailability.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">      therapist_appointment_schedule_id: @partial_one.therapist_appointment_schedule_id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">      specific_date: @partial_one.specific_date,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">      start_time: @partial_one.start_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">      end_time: @partial_one.end_time</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">    refute duplicate.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    assert_includes duplicate.errors[:specific_date],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">      &quot;Exact duplicate record already exists for this schedule, date, and time.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="77">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;mixed full/partial availability validations&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">    # Test partial conflict with full unavailable</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">    partial_conflict = TherapistAdjustedAvailability.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">      therapist_appointment_schedule: @unavailable_entire_day.therapist_appointment_schedule,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">      specific_date: @unavailable_entire_day.specific_date,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">      start_time: &quot;09:00&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">      end_time: &quot;10:00&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">    refute partial_conflict.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">    assert_includes partial_conflict.errors[:base], &quot;Cannot create partial availability if date is already fully unavailable&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">    # Test full unavailable with existing partial</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">    new_full = TherapistAdjustedAvailability.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">      therapist_appointment_schedule: @partial_one.therapist_appointment_schedule,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">      specific_date: @partial_one.specific_date,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">      start_time: nil,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">      end_time: nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">    refute new_full.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">    assert_includes new_full.errors[:base], &quot;Cannot mark date fully unavailable if partial availability exists for this date&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="99">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;adjusted availability must be within schedule window if not available_now&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">    # Our window_schedule might have start_date_window=Date.today, end_date_window=Date.today+30</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">    outside_date = @window_schedule.end_date_window + 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">    outside_record = TherapistAdjustedAvailability.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">      therapist_appointment_schedule: @window_schedule,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">      specific_date: outside_date,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby">      start_time: &quot;10:00&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">      end_time: &quot;12:00&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">    refute outside_record.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">    assert_includes outside_record.errors[:specific_date],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">      &quot;must be within the schedule date window (#{@window_schedule.start_date_window} - #{@window_schedule.end_date_window})&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="114">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;if schedule is available_now, no date window restriction&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">    # instant_schedule has available_now = true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">    record = TherapistAdjustedAvailability.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">      therapist_appointment_schedule: @instant_schedule,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby">      specific_date: Time.zone.today + 365,   # far in the future</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby">      start_time: &quot;10:00&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">      end_time: &quot;12:00&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">    assert record.valid?, record.errors.full_messages</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="125">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;past date validation&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">    past_record = TherapistAdjustedAvailability.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            

            <code class="ruby">      therapist_appointment_schedule: @instant_schedule,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby">      specific_date: Date.current - 1.day,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby">      start_time: &quot;10:00&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby">      end_time: &quot;12:00&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">    refute past_record.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">    assert_includes past_record.errors[:specific_date], &quot;cannot be in the past&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="136">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;overlapping time ranges validation&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">    therapist_adjusted_availabilities(:overlapping_availability_09)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">    time_2 = therapist_adjusted_availabilities(:overlapping_availability_11)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">    refute time_2.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">    assert_includes time_2.errors[:base],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby">      &quot;Time range overlaps with existing availability for #{time_2.specific_date}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="f46ab21382ce9740495ebe2a96ba4d7d74f71813">
  <div class="header">
    <h3>test/models/therapist_appointment_schedule_test.rb</h3>
    <h4>
      <span class="red">
  31.25%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>32</b> relevant lines.
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>22</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class TherapistAppointmentScheduleTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def setup</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @schedule_one = therapist_appointment_schedules(:schedule_for_therapist_one)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @schedule_two = therapist_appointment_schedules(:schedule_for_therapist_two)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;can create schedule if therapist is ACTIVE&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    assert @schedule_one.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  # test &quot;cannot create schedule if therapist is on HOLD&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">  #   @schedule_one.therapist.employment_status = &quot;HOLD&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">  #   refute @schedule_one.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">  #   assert_includes @schedule_one.errors[:base],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">  #     &quot;Cannot create or update a schedule for a non-active therapist&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="20">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;if available_now is true, start_date_window and end_date_window must be nil&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    @schedule_one.start_date_window = Date.current</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    refute @schedule_one.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">    # By default, Rails sets the error: &quot;must be blank&quot; for `absence: true`</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    assert_includes @schedule_one.errors[:start_date_window], &quot;must be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="27">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;if available_now is false, start_date_window and end_date_window must be present&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    @schedule_two.start_date_window = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    refute @schedule_two.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">    # For presence: true, the default error is: &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    assert_includes @schedule_two.errors[:start_date_window], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="34">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;end_date_window must be strictly after start_date_window if available_now is false&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    @schedule_two.end_date_window = @schedule_two.start_date_window</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    refute @schedule_two.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">    # Your custom message: &quot;must be after the start date&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">    assert_includes @schedule_two.errors[:end_date_window], &quot;must be after the start date&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="41">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;model must have either available_now or a start_date_window&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    @schedule_one.available_now = false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">    @schedule_one.start_date_window = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">    refute @schedule_one.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">    # &quot;You must set &#39;available now&#39; or provide a &#39;start date&#39;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">    assert_includes @schedule_one.errors[:base],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">      &quot;You must set &#39;available now&#39; or provide a &#39;start date&#39;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="50">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;appointment_duration_in_minutes must be &gt; 0&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">    @schedule_one.appointment_duration_in_minutes = 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">    refute @schedule_one.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">    assert_includes @schedule_one.errors[:appointment_duration_in_minutes],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">      &quot;must be greater than 0&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">  # You can similarly test the numeric fields: max_advance_booking_in_days, etc.</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="58">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;min_booking_before_in_hours must be &gt;= 0&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">    @schedule_one.min_booking_before_in_hours = -1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">    refute @schedule_one.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    assert_includes @schedule_one.errors[:min_booking_before_in_hours],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">      &quot;must be greater than or equal to 0&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="5a3d4bac68a7fa994e688a5106ffb360c6344653">
  <div class="header">
    <h3>test/models/therapist_bank_detail_test.rb</h3>
    <h4>
      <span class="red">
  46.15%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>13</b> relevant lines.
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class TherapistBankDetailTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def setup</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @therapist_one_bca = therapist_bank_details(:therapist_one_bca)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @therapist_two_mandiri = therapist_bank_details(:therapist_two_mandiri)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    @therapist_two_bni = therapist_bank_details(:therapist_two_bni)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  # Test validations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;valid therapist bank detail should be valid&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    assert @therapist_one_bca.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    assert @therapist_two_mandiri.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">  # test &quot;therapist bank detail should validate only one active bank detail per therapist&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">  #   new_active_detail = TherapistBankDetail.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">  #     therapist: therapists(:therapist_two),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  #     bank_detail: bank_details(:bni_1),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">  #     active: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  #   )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">  #   assert_not new_active_detail.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">  #   assert_includes new_active_detail.errors[:active], &quot;only one active bank detail is allowed per therapist&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">  # Test associations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="27">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should belong to a therapist&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    assert_equal therapists(:therapist_one), @therapist_one_bca.therapist</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="31">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should belong to a bank detail&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    assert_equal bank_details(:bca_1), @therapist_one_bca.bank_detail</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a8105570b3cf89c34efe160f8b414b9c6fb15fe9">
  <div class="header">
    <h3>test/models/therapist_document_test.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class TherapistDocumentTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # test &quot;the truth&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  #   assert true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="4da96644ea61e1d5cfc3492257346e96e42606fb">
  <div class="header">
    <h3>test/models/therapist_registration_counter_test.rb</h3>
    <h4>
      <span class="red">
  38.46%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>13</b> relevant lines.
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class TherapistRegistrationCounterTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def setup</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @fisiohome_counter = therapist_registration_counters(:fisiohome_counter)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @pusat_okupasi_counter = therapist_registration_counters(:pusat_okupasi_counter)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  # Test validations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;therapist_registration_counter should validate uniqueness of service_code&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    duplicate_counter = TherapistRegistrationCounter.new(service_code: @fisiohome_counter.service_code)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    assert_not duplicate_counter.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    assert_includes duplicate_counter.errors[:service_code], &quot;has already been taken&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">  # Test presence of service_code</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="17">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;therapist_registration_counter should be invalid without a service_code&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    @fisiohome_counter.service_code = &quot;CH&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    assert_not @fisiohome_counter.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    assert_includes @fisiohome_counter.errors[:service_code], &quot;CH is not a valid service code&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c906e8fe18a88f9f9709fbcacf16b44a5fe37521">
  <div class="header">
    <h3>test/models/therapist_test.rb</h3>
    <h4>
      <span class="red">
  28.38%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>74</b> relevant lines.
      <span class="green"><b>21</b> lines covered</span> and
      <span class="red"><b>53</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class TherapistTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def setup</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @therapist_one = therapists(:therapist_one)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @therapist_two = therapists(:therapist_two)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    @active_therapist = therapists(:active_therapist)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    @hold_therapist = therapists(:hold_therapist)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">  # Test validations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;valid therapist should be valid&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    assert @therapist_one.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    assert @therapist_two.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="17">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;therapist should validate presence of name&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    @therapist_one.name = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    assert_not @therapist_one.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    assert_includes @therapist_one.errors[:name], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="23">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;therapist should validate presence of phone_number&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    @therapist_one.phone_number = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    assert_not @therapist_one.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    assert_includes @therapist_one.errors[:phone_number], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="29">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;therapist should validate uniqueness of phone_number&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    duplicate = Therapist.new(phone_number: @therapist_one.phone_number, name: &quot;Duplicate Therapist&quot;, user: users(:therapist_user_one), service: services(:fisiohome))</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    assert_not duplicate.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    assert_includes duplicate.errors[:phone_number], &quot;has already been taken&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="35">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;therapist should validate presence of registration_number&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    @therapist_one.registration_number = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    assert @therapist_one.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="40">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;therapist should validate uniqueness of registration_number&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    duplicate = Therapist.new(registration_number: @therapist_one.registration_number, name: &quot;Duplicate Therapist&quot;, phone_number: &quot;+6281234567894&quot;, user: users(:therapist_user_one), service: services(:fisiohome))</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    assert_not duplicate.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">    assert_includes duplicate.errors[:registration_number], &quot;has already been taken&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">  # Test associations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="47">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should belong to a user&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    assert_equal users(:therapist_user_one), @therapist_one.user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="51">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should belong to a service&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">    assert_equal services(:fisiohome), @therapist_one.service</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="55">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should have many addresses through therapist_addresses&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">    assert_includes @therapist_one.addresses, addresses(:jakarta_selatan_address)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="59">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should have one active address&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">    assert_equal addresses(:jakarta_selatan_address), @therapist_one.active_address</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="63">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should have many bank details through therapist_bank_details&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">    assert_includes @therapist_two.bank_details, bank_details(:mandiri_1)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="67">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should have one active bank detail&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">    assert_equal bank_details(:mandiri_1), @therapist_two.active_bank_detail</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">  # Test callbacks</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="72">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;assign_registration_number should generate unique registration number&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    assert @therapist_one.registration_number.start_with?(&quot;FH&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="76">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;update_user_suspend_status should update user&#39;s suspension status&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">    @hold_therapist.update!(employment_status: &quot;ACTIVE&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">    assert_nil @hold_therapist.user.suspend_at</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">    assert_nil @hold_therapist.user.suspend_end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">    @hold_therapist.update!(employment_status: &quot;HOLD&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">    assert_not_nil @hold_therapist.user.suspend_at</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">    assert_not_nil @hold_therapist.user.suspend_end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="86">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;destroy_associated_user should delete user&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">    delete_therapist = therapists(:delete_therapist)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">    user = delete_therapist.user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">    assert_difference &quot;User.count&quot;, -1 do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">      delete_therapist.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">    assert_not User.exists?(user.id), &quot;Associated user was not destroyed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="95">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;destroy_associated_addresses should delete addresses&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">    delete_therapist = therapists(:delete_therapist)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">    address = delete_therapist.addresses.first</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">    assert_difference &quot;Address.count&quot;, -1 do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">      delete_therapist.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">    assert_not Address.exists?(address.id), &quot;Associated address was not destroyed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="104">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;destroy_associated_bank_details should delete bank details&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">    delete_therapist = therapists(:delete_therapist)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">    bank_detail = delete_therapist.bank_details.first</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">    assert_difference &quot;BankDetail.count&quot;, -1 do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">      delete_therapist.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">    assert_not BankDetail.exists?(bank_detail.id), &quot;Associated bank detail was not destroyed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="113">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;destroying therapist should destroy associated therapist_appointment_schedule&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">    delete_therapist = therapists(:delete_therapist)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">    schedule = therapist_appointment_schedules(:therapist_schedule_delete) # Create a fixture for this</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">    assert_difference &quot;TherapistAppointmentSchedule.count&quot;, -1 do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">      delete_therapist.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">    assert_not TherapistAppointmentSchedule.exists?(schedule.id), &quot;Associated TherapistAppointmentSchedule was not destroyed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="3deed34800fdf4b7eb4811d40e43493ba896409f">
  <div class="header">
    <h3>test/models/therapist_weekly_availability_test.rb</h3>
    <h4>
      <span class="red">
  21.57%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>51</b> relevant lines.
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>40</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class TherapistWeeklyAvailabilityTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def setup</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">    # Example fixture references</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @monday_morning = therapist_weekly_availabilities(:monday_morning_for_therapist_one)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    @monday_afternoon = therapist_weekly_availabilities(:monday_afternoon_for_therapist_one)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;fixtures are valid&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    assert @monday_morning.valid?, @monday_morning.errors.full_messages</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    assert @monday_afternoon.valid?, @monday_afternoon.errors.full_messages</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;day_of_week must be from Date::DAYNAMES&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    @monday_morning.day_of_week = &quot;Funday&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    refute @monday_morning.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    assert_includes @monday_morning.errors[:day_of_week],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">      &quot;Funday is not a valid day of the week&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="22">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;start_time must be before end_time&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">    # This test requires you add the recommended `end_time_after_start_time` check</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    @monday_morning.start_time = &quot;14:00&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    @monday_morning.end_time = &quot;13:59&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    refute @monday_morning.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    assert_includes @monday_morning.errors[:end_time],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">      &quot;must be after the start time&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="31">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;exact duplicate is caught by model validation&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    existing = therapist_weekly_availabilities(:monday_morning_for_therapist_one)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">    duplicate = TherapistWeeklyAvailability.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">      therapist_appointment_schedule_id: existing.therapist_appointment_schedule_id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">      day_of_week: existing.day_of_week,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">      start_time: existing.start_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">      end_time: existing.end_time</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    refute duplicate.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    assert_includes duplicate.errors[:end_time],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">      &quot;Exact availability for this day/time range already exists&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="45">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;time presence validation&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">    # 1) One is present, the other absent =&gt; invalid</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">    @monday_morning.start_time = &quot;09:00&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    @monday_morning.end_time = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    refute @monday_morning.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">    assert_includes @monday_morning.errors[:base],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">      &quot;Start time and end time must both be present or both absent&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">    # 2) The opposite: end_time present, start_time absent =&gt; also invalid</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">    @monday_morning.start_time = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    @monday_morning.end_time = &quot;10:00&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">    refute @monday_morning.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">    assert_includes @monday_morning.errors[:base],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">      &quot;Start time and end time must both be present or both absent&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">    # 3) Both nil =&gt; valid if your logic allows a no time scenario</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    @monday_morning.start_time = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    @monday_morning.end_time = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">    assert @monday_morning.valid?, @monday_morning.errors.full_messages</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">    # 4) Both present =&gt; valid</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">    @monday_morning.start_time = &quot;09:00&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">    @monday_morning.end_time = &quot;11:00&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">    assert @monday_morning.valid?, @monday_morning.errors.full_messages</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="71">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;overlapping availability detection&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">    therapist_weekly_availabilities(:friday_morning_for_therapist_two)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    overlap = therapist_weekly_availabilities(:friday_overlapping_for_therapist_two)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">    refute overlap.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">    assert_includes overlap.errors[:base],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">      &quot;Time range overlaps with existing availability for Friday&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="80">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;non-overlapping availability&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">    therapist_weekly_availabilities(:monday_morning_for_therapist_one)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">    therapist_weekly_availabilities(:monday_afternoon_for_therapist_one)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">    existing_evening = therapist_weekly_availabilities(:monday_evening_for_therapist_one)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">    assert existing_evening.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="88">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;different schedules don&#39;t conflict&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">    # Copy schedule one&#39;s availability to schedule two</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">    existing = therapist_weekly_availabilities(:friday_morning_for_therapist_two)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">    availability = TherapistWeeklyAvailability.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">      therapist_appointment_schedule_id: existing.therapist_appointment_schedule_id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">      day_of_week: &quot;Friday&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">      start_time: &quot;13:00&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">      end_time: &quot;14:00&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">    assert availability.valid?, availability.errors.full_messages</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e28a5acdcfc98cab9bf1b59744cf20f81c92f8d1">
  <div class="header">
    <h3>test/models/user_test.rb</h3>
    <h4>
      <span class="red">
  39.53%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>43</b> relevant lines.
      <span class="green"><b>17</b> lines covered</span> and
      <span class="red"><b>26</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class UserTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def setup</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @active_user = users(:active_user)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @suspended_user = users(:suspended_user)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    @permanently_suspended_user = users(:permanently_suspended_user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  # Test validations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;valid user should be valid&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    assert @active_user.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;email presence should be validated&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    @active_user.email = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    assert_not @active_user.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    assert_includes @active_user.errors[:email], &quot;can&#39;t be blank&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="21">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;email uniqueness should be validated&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    duplicate_user = User.new(email: @active_user.email, password: &quot;Password123!&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    assert_not duplicate_user.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    assert_includes duplicate_user.errors[:email], &quot;has already been taken&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">  # Test `is_online?` method</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="28">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;is_online? should return true if last_online_at is recent&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    assert @active_user.is_online?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="32">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;is_online? should return false if last_online_at is too old&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">    @active_user.last_online_at = 10.minutes.ago</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    assert_not @active_user.is_online?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">  # Test `suspended?` method</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="38">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;suspended? should return true if user is suspended within the timeframe&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    assert @suspended_user.suspended?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="42">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;suspended? should return false if suspend_end has passed&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">    @suspended_user.suspend_end = 1.minute.ago</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">    assert_not @suspended_user.suspended?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="47">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;suspended? should return true if suspend_end is not set but suspend_at is past&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    assert @permanently_suspended_user.suspended?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="51">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;suspended? should return false if suspend_at is not set&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">    @active_user.suspend_at = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">    assert_not @active_user.suspended?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">  # Test Devise overrides</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="57">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;active_for_authentication? should return true for active user&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">    assert @active_user.active_for_authentication?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="61">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;active_for_authentication? should return false for suspended user&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    assert_not @suspended_user.active_for_authentication?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="65">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;inactive_message should return :locked if user is not suspended&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">    assert_equal :locked, @active_user.inactive_message</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="69">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;inactive_message should return Devise default message for suspended user&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    assert_not_equal :locked, @suspended_user.inactive_message</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">  # Test associations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="74">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;destroying user should destroy associated admin&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">    Admin.create!(user: @active_user, admin_type: &quot;SUPER_ADMIN&quot;, name: &quot;Test Admin&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">    assert_difference &quot;Admin.count&quot;, -1 do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">      @active_user.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">  # ? TECH-DEBT - will be skipped for now</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">  # test &quot;destroying user should destroy associated therapist&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">  #   therapist = therapists(:active_therapist)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">  #   assert_difference &quot;Therapist.count&quot;, -1 do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">  #     therapist.user.destroy!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">  #   end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">  # end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ac1e39d28f1e38c290d083107b680566fa81420e">
  <div class="header">
    <h3>test/services/get_therapist_available_service_test.rb</h3>
    <h4>
      <span class="red">
  14.77%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>176</b> relevant lines.
      <span class="green"><b>26</b> lines covered</span> and
      <span class="red"><b>150</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;test_helper&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class GetTherapistAvailableServiceTest &lt; ActiveSupport::TestCase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # ---------------------------------------------------------------------------</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  # Test Setup</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # ---------------------------------------------------------------------------</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def setup</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">    # Create base test data that will be used across multiple tests</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    @therapist = therapists(:therapist_one)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    @schedule = therapist_appointment_schedules(:schedule_for_therapist_one)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    @appointment_date_time = 1.day.from_now</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    # Ensure correct weekly availabilities for Monday</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    @schedule.therapist_weekly_availabilities.destroy_all</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">    [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">      {start: [9, 0], end: [12, 0]},</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">      {start: [13, 0], end: [16, 0]},</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">      {start: [17, 0], end: [18, 0]}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    ].each do |slot|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">      @schedule.therapist_weekly_availabilities.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">        day_of_week: &quot;Monday&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">        start_time: Time.zone.local(2000, 1, 1, *slot[:start]),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">        end_time: Time.zone.local(2000, 1, 1, *slot[:end])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">    # Remove all adjusted availabilities for the schedule</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    @schedule.therapist_adjusted_availabilities.destroy_all</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">    # Reload the schedule to ensure the weekly availabilities are loaded</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    @schedule.reload</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">    # Initialize the service with default parameters</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    @service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">      appointment_date_time_server_time: @appointment_date_time</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">  # ---------------------------------------------------------------------------</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">  # Basic Availability Tests</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">  # These tests verify fundamental availability logic</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">  # ---------------------------------------------------------------------------</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">  # Test: Therapist is available when all conditions are met (Monday, 10 AM)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">  # This is the happy path - all constraints are satisfied</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="48">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should be available when all conditions are met&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    appointment_time = next_monday_at(10, 0)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">    service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">      appointment_date_time_server_time: appointment_time</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">    assert service.available?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    assert_empty service.reasons</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">  # Test: Therapist with no schedule should not be available</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">  # Edge case: therapist exists but has no appointment schedule configured</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="60">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should not be available when therapist has no schedule&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    therapist_without_schedule = therapists(:therapist_two)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    therapist_without_schedule.therapist_appointment_schedule&amp;.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">    service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">      therapist: therapist_without_schedule,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">      appointment_date_time_server_time: @appointment_date_time</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">    refute service.available?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">    # Note: No reasons are added in this case, just logs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">  # Test: Therapist is not available for past dates</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">  # Business rule: Cannot book appointments in the past</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="74">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should not be available for past dates&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">    past_time = 1.hour.ago</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">    service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">      appointment_date_time_server_time: past_time</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">    refute service.available?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">    assert_includes service.reasons, &quot;Not available for past dates&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">  # Test: Not available when appointment exceeds max advance booking days</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">  # Business rule: Cannot book too far in advance (prevents overbooking)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="86">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should not be available when exceeds max advance booking&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">    # Create a time that&#39;s beyond the allowed advance booking period</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">    future_time = (@schedule.max_advance_booking_in_days + 1).days.from_now</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">    service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">      appointment_date_time_server_time: future_time</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">    refute service.available?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">    assert_includes service.reasons, &quot;Exceeds max advance booking (#{@schedule.max_advance_booking_in_days} days)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">  # ---------------------------------------------------------------------------</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">  # Window Constraints Tests</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">  # These tests verify date window restrictions (start/end date windows)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">  # ---------------------------------------------------------------------------</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">  # Test: Not available if appointment is before start date window</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">  # Business rule: Therapists can set a future start date for accepting bookings</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="105">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should not be available before start date window&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">    window_schedule = therapist_appointment_schedules(:window_schedule)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">    # Set window to start 5 days from now</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">    window_schedule.update(start_date_window: Date.current + 5.days, end_date_window: Date.current + 30.days)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">    window_schedule.reload</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">    # Try to book 2 days from now (before the window starts)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">    appointment_time = Date.current + 2.days</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">    fail &quot;Test setup error: appointment_time &gt;= start_date_window&quot; if window_schedule.start_date_window &amp;&amp; appointment_time &gt;= window_schedule.start_date_window</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">    therapist = window_schedule.therapist</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">    service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">      therapist: therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby">      appointment_date_time_server_time: appointment_time.to_time.change(hour: 10, min: 0)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">    refute service.available?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">    assert service.reasons.any? { |reason| reason.include?(&quot;Before start date window&quot;) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">  # Test: Not available if appointment is after end date window</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby">  # Business rule: Therapists can set an end date after which they stop accepting bookings</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="126">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should not be available after end date window&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">    window_schedule = therapist_appointment_schedules(:window_schedule)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby">    # Set window to end 3 days from now</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">    window_schedule.update(start_date_window: Date.current, end_date_window: Date.current + 3.days, max_advance_booking_in_days: 30)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">    window_schedule.reload</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">    # Try to book 10 days from now (after the window ends)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">    appointment_time = Date.current + 10.days</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">    fail &quot;Test setup error: appointment_time &lt;= end_date_window&quot; if window_schedule.end_date_window &amp;&amp; appointment_time &lt;= window_schedule.end_date_window</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">    therapist = window_schedule.therapist</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">    service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby">      therapist: therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby">      appointment_date_time_server_time: appointment_time.to_time.change(hour: 10, min: 0)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">    refute service.available?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">    assert service.reasons.any? { |reason| reason.include?(&quot;After end date window&quot;) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">  # ---------------------------------------------------------------------------</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">  # Weekly Slot Logic Tests</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby">  # These tests verify weekly availability patterns (day of week + time slots)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby">  # ---------------------------------------------------------------------------</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby">  # Test: Not available when no weekly slots exist for the requested day</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby">  # Business rule: Each day of the week can have different availability patterns</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="152">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should not be available when no weekly slots exist&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">    # Test on a day that doesn&#39;t have weekly availability (e.g., Tuesday)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">    appointment_time = next_tuesday_at(10, 0)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">    service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby">      appointment_date_time_server_time: appointment_time</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">    refute service.available?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">    assert service.reasons.any? { |r| r.include?(&quot;No weekly slots for #{appointment_time.strftime(&quot;%A&quot;)}&quot;) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby">  # Test: Not available when time is outside weekly slot</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="164">
            

            

            <code class="ruby">  # Business rule: Even on available days, specific time windows apply</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="165">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should not be available when time is outside weekly slot&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="166">
            

            

            <code class="ruby">    # Test Monday at 8 AM (outside 9 AM - 12 PM slot)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">    appointment_time = next_monday_at(8, 0)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">    service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            

            <code class="ruby">      appointment_date_time_server_time: appointment_time</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">    refute service.available?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">    assert service.reasons.any? { |reason| reason.include?(&quot;Outside weekly availability for Monday&quot;) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            

            <code class="ruby">    # Test Monday at 12:30 PM (between 12:00 and 13:00 slots)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">    appointment_time_between = next_monday_at(12, 30)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">    service_between = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            

            

            <code class="ruby">      appointment_date_time_server_time: appointment_time_between</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="181">
            

            

            <code class="ruby">    refute service_between.available?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="182">
            

            

            <code class="ruby">    assert service_between.reasons.any? { |reason| reason.include?(&quot;Outside weekly availability for Monday&quot;) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="185">
            

            

            <code class="ruby">  # Test: Should be available when time fits within weekly slot</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="186">
            

            

            <code class="ruby">  # Happy path: Requested time falls within configured weekly availability</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="187">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should be available when time fits within weekly slot&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="188">
            

            

            <code class="ruby">    # Test Monday at 10 AM (within 9 AM - 12 PM slot)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">    appointment_time = next_monday_at(10, 0)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="190">
            

            

            <code class="ruby">    service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="191">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="192">
            

            

            <code class="ruby">      appointment_date_time_server_time: appointment_time</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="193">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="194">
            

            

            <code class="ruby">    assert service.available?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="195">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="196">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="197">
            

            

            <code class="ruby">  # Test: Should handle time zone conversion correctly</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="198">
            

            

            <code class="ruby">  # Edge case: Therapist and server may be in different time zones</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="199">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should handle time zone conversion correctly&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="200">
            

            

            <code class="ruby">    @schedule.update(time_zone: &quot;America/New_York&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="201">
            

            

            <code class="ruby">    @schedule.reload</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="202">
            

            

            <code class="ruby">    @therapist.reload</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="203">
            

            

            <code class="ruby">    @schedule = @therapist.therapist_appointment_schedule</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="204">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="205">
            

            

            <code class="ruby">    # Recreate weekly availabilities for the new time zone</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="206">
            

            

            <code class="ruby">    @schedule.therapist_weekly_availabilities.destroy_all</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="207">
            

            

            <code class="ruby">    [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="208">
            

            

            <code class="ruby">      {start: [9, 0], end: [12, 0]},</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="209">
            

            

            <code class="ruby">      {start: [13, 0], end: [16, 0]},</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="210">
            

            

            <code class="ruby">      {start: [17, 0], end: [18, 0]}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="211">
            

            

            <code class="ruby">    ].each do |slot|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="212">
            

            

            <code class="ruby">      @schedule.therapist_weekly_availabilities.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="213">
            

            

            <code class="ruby">        day_of_week: &quot;Monday&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="214">
            

            

            <code class="ruby">        start_time: Time.zone.local(2000, 1, 1, *slot[:start]),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="215">
            

            

            <code class="ruby">        end_time: Time.zone.local(2000, 1, 1, *slot[:end])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="216">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="217">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="218">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="219">
            

            

            <code class="ruby">    service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="220">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="221">
            

            

            <code class="ruby">      appointment_date_time_server_time: next_monday_at(10, 0)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="222">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="223">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="224">
            

            

            <code class="ruby">    # Should still work correctly with time zone conversion</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="225">
            

            

            <code class="ruby">    assert service.available?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="226">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="227">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="228">
            

            

            <code class="ruby">  # Test: Should handle multiple weekly slots on the same day</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="229">
            

            

            <code class="ruby">  # Business rule: A single day can have multiple time slots (e.g., morning and afternoon)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="230">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should handle multiple weekly slots&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="231">
            

            

            <code class="ruby">    # Use existing Monday slots from fixtures (morning and afternoon)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="232">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="233">
            

            

            <code class="ruby">    # Test appointment in first slot (9 AM - 12 PM)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="234">
            

            

            <code class="ruby">    service_1 = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="235">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="236">
            

            

            <code class="ruby">      appointment_date_time_server_time: next_monday_at(10, 0)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="237">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="238">
            

            

            <code class="ruby">    assert service_1.available?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="239">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="240">
            

            

            <code class="ruby">    # Test appointment in second slot (1 PM - 4 PM)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="241">
            

            

            <code class="ruby">    appointment_time_14 = next_monday_at(14, 0)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="242">
            

            

            <code class="ruby">    service_2 = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="243">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="244">
            

            

            <code class="ruby">      appointment_date_time_server_time: appointment_time_14</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="245">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="246">
            

            

            <code class="ruby">    assert service_2.available?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="247">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="248">
            

            

            <code class="ruby">    # Test appointment between slots (12:30 PM) - should be unavailable</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="249">
            

            

            <code class="ruby">    service_3 = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="250">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="251">
            

            

            <code class="ruby">      appointment_date_time_server_time: next_monday_at(12, 30)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="252">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="253">
            

            

            <code class="ruby">    available = service_3.available?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="254">
            

            

            <code class="ruby">    refute available</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="255">
            

            

            <code class="ruby">    assert service_3.reasons.any? { |reason| reason.include?(&quot;Outside weekly availability for Monday&quot;) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="256">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="257">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="258">
            

            

            <code class="ruby">  # ---------------------------------------------------------------------------</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="259">
            

            

            <code class="ruby">  # Adjusted Availability Tests</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="260">
            

            

            <code class="ruby">  # These tests verify one-time availability overrides (holidays, sick days, etc.)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="261">
            

            

            <code class="ruby">  # ---------------------------------------------------------------------------</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="262">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="263">
            

            

            <code class="ruby">  # Test: Not available when adjusted availability is set to unavailable</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="264">
            

            

            <code class="ruby">  # Business rule: Therapists can mark specific dates as completely unavailable</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="265">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should not be available when adjusted availability is set to unavailable&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="266">
            

            

            <code class="ruby">    # Create adjusted availability directly for the test date</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="267">
            

            

            <code class="ruby">    adjusted_date = next_monday_at(10, 0).to_date</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="268">
            

            

            <code class="ruby">    @schedule.therapist_adjusted_availabilities.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="269">
            

            

            <code class="ruby">      specific_date: adjusted_date,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="270">
            

            

            <code class="ruby">      start_time: nil,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="271">
            

            

            <code class="ruby">      end_time: nil,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="272">
            

            

            <code class="ruby">      reason: &quot;Holiday&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="273">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="274">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="275">
            

            

            <code class="ruby">    service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="276">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="277">
            

            

            <code class="ruby">      appointment_date_time_server_time: next_monday_at(10, 0)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="278">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="279">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="280">
            

            

            <code class="ruby">    refute service.available?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="281">
            

            

            <code class="ruby">    # Check for any message containing &quot;Unavailable on&quot; and the date</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="282">
            

            

            <code class="ruby">    assert service.reasons.any? { |reason| reason.include?(&quot;Unavailable on #{adjusted_date}&quot;) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="283">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="284">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="285">
            

            

            <code class="ruby">  # Test: Should be available when adjusted availability has valid times</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="286">
            

            

            <code class="ruby">  # Business rule: Therapists can modify hours for specific dates (e.g., half-day)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="287">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should be available when adjusted availability has valid times&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="288">
            

            

            <code class="ruby">    # Create adjusted availability directly for the test date</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="289">
            

            

            <code class="ruby">    adjusted_date = next_monday_at(10, 0).to_date</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="290">
            

            

            <code class="ruby">    therapist_tz = @schedule.time_zone || Time.zone.name</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="291">
            

            

            <code class="ruby">    start_time = Time.use_zone(therapist_tz) { Time.zone.local(2000, 1, 1, 9, 0) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="292">
            

            

            <code class="ruby">    end_time = Time.use_zone(therapist_tz) { Time.zone.local(2000, 1, 1, 12, 0) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="293">
            

            

            <code class="ruby">    @schedule.therapist_adjusted_availabilities.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="294">
            

            

            <code class="ruby">      specific_date: adjusted_date,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="295">
            

            

            <code class="ruby">      start_time: start_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="296">
            

            

            <code class="ruby">      end_time: end_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="297">
            

            

            <code class="ruby">      reason: &quot;Half day&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="298">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="299">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="300">
            

            

            <code class="ruby">    service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="301">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="302">
            

            

            <code class="ruby">      appointment_date_time_server_time: next_monday_at(10, 0) # 10 AM</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="303">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="304">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="305">
            

            

            <code class="ruby">    assert service.available?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="306">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="307">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="308">
            

            

            <code class="ruby">  # Test: Not available when time is outside adjusted availability</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="309">
            

            

            <code class="ruby">  # Business rule: Even on adjusted dates, time constraints still apply</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="310">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should not be available when time is outside adjusted availability&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="311">
            

            

            <code class="ruby">    # Create adjusted availability directly for the test date</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="312">
            

            

            <code class="ruby">    adjusted_date = next_monday_at(10, 0).to_date</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="313">
            

            

            <code class="ruby">    @schedule.therapist_adjusted_availabilities.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="314">
            

            

            <code class="ruby">      specific_date: adjusted_date,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="315">
            

            

            <code class="ruby">      start_time: Time.zone.parse(&quot;09:00&quot;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="316">
            

            

            <code class="ruby">      end_time: Time.zone.parse(&quot;12:00&quot;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="317">
            

            

            <code class="ruby">      reason: &quot;Half day&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="318">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="319">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="320">
            

            

            <code class="ruby">    service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="321">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="322">
            

            

            <code class="ruby">      appointment_date_time_server_time: next_monday_at(8, 0) # 8 AM</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="323">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="324">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="325">
            

            

            <code class="ruby">    refute service.available?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="326">
            

            

            <code class="ruby">    # Check for any message containing &quot;Outside the availability hours&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="327">
            

            

            <code class="ruby">    assert service.reasons.any? { |reason| reason.include?(&quot;Outside the adjusted availability hours&quot;) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="328">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="329">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="330">
            

            

            <code class="ruby">  # ---------------------------------------------------------------------------</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="331">
            

            

            <code class="ruby">  # Max Daily Appointments Tests</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="332">
            

            

            <code class="ruby">  # These tests verify daily appointment limits</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="333">
            

            

            <code class="ruby">  # ---------------------------------------------------------------------------</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="334">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="335">
            

            

            <code class="ruby">  # Test: Should be available for all-of-day when therapist has weekly availability</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="336">
            

            

            <code class="ruby">  # Business rule: &quot;All of day&quot; bookings bypass time slot restrictions</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="337">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should be available for all-of-day when therapist has weekly availability&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="338">
            

            

            <code class="ruby">    appointment_time = next_monday_at(9, 0)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="339">
            

            

            <code class="ruby">    @schedule.update!(appointment_duration_in_minutes: 60, buffer_time_in_minutes: 0, max_daily_appointments: 10)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="340">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="341">
            

            

            <code class="ruby">    service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="342">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="343">
            

            

            <code class="ruby">      appointment_date_time_server_time: appointment_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="344">
            

            

            <code class="ruby">      is_all_of_day: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="345">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="346">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="347">
            

            

            <code class="ruby">    assert service.available?, &quot;Therapist should be available for all-of-day on Monday&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="348">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="349">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="350">
            

            

            <code class="ruby">  # Test: Not available for all-of-day on past dates</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="351">
            

            

            <code class="ruby">  # Business rule: Even &quot;all of day&quot; bookings cannot be in the past</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="352">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should not be available for all-of-day on past dates&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="353">
            

            

            <code class="ruby">    past_time = 1.day.ago</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="354">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="355">
            

            

            <code class="ruby">    service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="356">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="357">
            

            

            <code class="ruby">      appointment_date_time_server_time: past_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="358">
            

            

            <code class="ruby">      is_all_of_day: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="359">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="360">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="361">
            

            

            <code class="ruby">    refute service.available?, &quot;Therapist should not be available for past dates&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="362">
            

            

            <code class="ruby">    assert_includes service.reasons, &quot;Not available for past dates&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="363">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="364">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="365">
            

            

            <code class="ruby">  # Test: Not available when therapist has reached max daily appointments</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="366">
            

            

            <code class="ruby">  # Business rule: Prevent overbooking by enforcing daily appointment limits</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="367">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should not be available when therapist has reached max daily appointments&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="368">
            

            

            <code class="ruby">    schedule = @therapist.therapist_appointment_schedule</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="369">
            

            

            <code class="ruby">    appointment_date = next_monday_at(10, 0).to_date</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="370">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="371">
            

            

            <code class="ruby">    # Set max daily appointments to 4 for this test</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="372">
            

            

            <code class="ruby">    schedule.update!(max_daily_appointments: 4)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="373">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="374">
            

            

            <code class="ruby">    # Create exactly the maximum allowed appointments (4 appointments)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="375">
            

            

            <code class="ruby">    create_max_daily_appointments(@therapist, schedule, appointment_date)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="376">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="377">
            

            

            <code class="ruby">    @therapist.reload</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="378">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="379">
            

            

            <code class="ruby">    # After creating max allowed appointments, try to book a new appointment</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="380">
            

            

            <code class="ruby">    # Use a time within the weekly availability windows (9:00-12:00, 13:00-16:00, 17:00-18:00)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="381">
            

            

            <code class="ruby">    # Ensure the time is in the future in therapist&#39;s time zone</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="382">
            

            

            <code class="ruby">    future_time = next_monday_at(9, 0)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="383">
            

            

            <code class="ruby">    service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="384">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="385">
            

            

            <code class="ruby">      appointment_date_time_server_time: future_time</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="386">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="387">
            

            

            <code class="ruby">    available = service.available?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="388">
            

            

            <code class="ruby">    refute available, &quot;Therapist should not be available after reaching max daily appointments&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="389">
            

            

            <code class="ruby">    assert service.reasons.any? { |reason| reason.include?(&quot;has reached max daily appointments&quot;) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="390">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="391">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="392">
            

            

            <code class="ruby">  # ---------------------------------------------------------------------------</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="393">
            

            

            <code class="ruby">  # Time Slot Generation Tests</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="394">
            

            

            <code class="ruby">  # These tests verify the available_time_slots_for_date method</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="395">
            

            

            <code class="ruby">  # ---------------------------------------------------------------------------</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="396">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="397">
            

            

            <code class="ruby">  # Test: Should generate correct time slots for a full day without appointments</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="398">
            

            

            <code class="ruby">  # Business rule: Generate 30-minute intervals within availability windows</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="399">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should generate correct time slots for full day without appointments&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="400">
            

            

            <code class="ruby">    appointment_date = next_monday_at(9, 0).to_date</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="401">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="402">
            

            

            <code class="ruby">    service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="403">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="404">
            

            

            <code class="ruby">      appointment_date_time_server_time: appointment_date.to_time.change(hour: 9, min: 0)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="405">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="406">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="407">
            

            

            <code class="ruby">    slots = service.available_time_slots_for_date</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="408">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="409">
            

            

            <code class="ruby">    # Should include slots from all three availability windows:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="410">
            

            

            <code class="ruby">    # 09:00-12:00, 13:00-16:00, 17:00-18:00</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="411">
            

            

            <code class="ruby">    # With 90-minute appointments, last possible start times are:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="412">
            

            

            <code class="ruby">    # 09:00-12:00: 10:30 (10:30+90min=12:00)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="413">
            

            

            <code class="ruby">    # 13:00-16:00: 14:30 (14:30+90min=16:00)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="414">
            

            

            <code class="ruby">    # 17:00-18:00: 17:00 (17:00+90min=18:30, but window ends at 18:00, so only 17:00)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="415">
            

            

            <code class="ruby">    expected_slots = [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="416">
            

            

            <code class="ruby">      &quot;09:00&quot;, &quot;09:30&quot;, &quot;10:00&quot;, &quot;10:30&quot;, &quot;11:00&quot;, &quot;11:30&quot;, &quot;12:00&quot;, # 09:00-12:00</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="417">
            

            

            <code class="ruby">      &quot;13:00&quot;, &quot;13:30&quot;, &quot;14:00&quot;, &quot;14:30&quot;, &quot;15:00&quot;, &quot;15:30&quot;, &quot;16:00&quot;, # 13:00-16:00</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="418">
            

            

            <code class="ruby">      &quot;17:00&quot;, &quot;17:30&quot;, &quot;18:00&quot; # 17:00-18:00</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="419">
            

            

            <code class="ruby">    ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="420">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="421">
            

            

            <code class="ruby">    assert_equal expected_slots, slots</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="422">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="423">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="424">
            

            

            <code class="ruby">  # Test: Should respect appointment duration and buffer when calculating overlaps</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="425">
            

            

            <code class="ruby">  # Business rule: New appointments must not overlap with existing appointments including buffer</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="426">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  test &quot;should respect appointment duration and buffer when calculating overlaps&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="427">
            

            

            <code class="ruby">    appointment_date = next_monday_at(9, 0).to_date</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="428">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="429">
            

            

            <code class="ruby">    # Create appointment with 60 min duration + 30 min buffer = 90 min total</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="430">
            

            

            <code class="ruby">    # Appointment at 13:00 should block until 14:30</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="431">
            

            

            <code class="ruby">    create_appointment(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="432">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="433">
            

            

            <code class="ruby">      appointment_date_time: appointment_date.to_time.change(hour: 13, min: 0),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="434">
            

            

            <code class="ruby">      duration: 60,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="435">
            

            

            <code class="ruby">      buffer: 30,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="436">
            

            

            <code class="ruby">      seq: 4</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="437">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="438">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="439">
            

            

            <code class="ruby">    service = AdminPortal::GetTherapistAvailableService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="440">
            

            

            <code class="ruby">      therapist: @therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="441">
            

            

            <code class="ruby">      appointment_date_time_server_time: appointment_date.to_time.change(hour: 9, min: 0)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="442">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="443">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="444">
            

            

            <code class="ruby">    slots = service.available_time_slots_for_date</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="445">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="446">
            

            

            <code class="ruby">    # 14:00 is available, 14:30 is available</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="447">
            

            

            <code class="ruby">    assert_includes slots, &quot;14:00&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="448">
            

            

            <code class="ruby">    assert_includes slots, &quot;14:30&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="449">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="450">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="451">
            

            

            <code class="ruby">  # ---------------------------------------------------------------------------</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="452">
            

            

            <code class="ruby">  # Helper Methods</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="453">
            

            

            <code class="ruby">  # These methods support the test cases above</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="454">
            

            

            <code class="ruby">  # ---------------------------------------------------------------------------</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="455">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="456">
            

            

            <code class="ruby">  # Helper: Create an appointment with specific duration and buffer</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="457">
            

            

            <code class="ruby">  # @param therapist [Therapist] The therapist for the appointment</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="458">
            

            

            <code class="ruby">  # @param appointment_date_time [DateTime] The appointment time</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="459">
            

            

            <code class="ruby">  # @param duration [Integer] Duration in minutes</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="460">
            

            

            <code class="ruby">  # @param buffer [Integer] Buffer time in minutes</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="461">
            

            

            <code class="ruby">  # @param seq [Integer] Sequence number for uniqueness</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="462">
            

            

            <code class="ruby">  # @return [Appointment] The created appointment</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="463">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def create_appointment(therapist:, appointment_date_time:, duration:, buffer:, seq: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="464">
            

            

            <code class="ruby">    # Update the therapist&#39;s schedule to match the test requirements</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="465">
            

            

            <code class="ruby">    schedule = therapist.therapist_appointment_schedule</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="466">
            

            

            <code class="ruby">    schedule.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="467">
            

            

            <code class="ruby">      appointment_duration_in_minutes: duration,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="468">
            

            

            <code class="ruby">      buffer_time_in_minutes: buffer</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="469">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="470">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="471">
            

            

            <code class="ruby">    # Use a sequence for uniqueness if provided</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="472">
            

            

            <code class="ruby">    uniq = seq || SecureRandom.hex(4)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="473">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="474">
            

            

            <code class="ruby">    Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="475">
            

            

            <code class="ruby">      therapist: therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="476">
            

            

            <code class="ruby">      patient: Patient.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="477">
            

            

            <code class="ruby">        name: &quot;Test Patient #{uniq}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="478">
            

            

            <code class="ruby">        date_of_birth: &quot;2000-01-01&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="479">
            

            

            <code class="ruby">        gender: &quot;MALE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="480">
            

            

            <code class="ruby">        patient_contact: PatientContact.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="481">
            

            

            <code class="ruby">          contact_name: &quot;Test Patient #{uniq}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="482">
            

            

            <code class="ruby">          contact_phone: &quot;6289172123#{uniq}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="483">
            

            

            <code class="ruby">          email: &quot;testpatient#{uniq}@yopmail.com&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="484">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="485">
            

            

            <code class="ruby">      ),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="486">
            

            

            <code class="ruby">      service: Service.first,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="487">
            

            

            <code class="ruby">      package: Package.first,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="488">
            

            

            <code class="ruby">      location: Location.first,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="489">
            

            

            <code class="ruby">      appointment_date_time: appointment_date_time,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="490">
            

            

            <code class="ruby">      preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="491">
            

            

            <code class="ruby">      patient_medical_record_attributes: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="492">
            

            

            <code class="ruby">        complaint_description: &quot;Test complaint&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="493">
            

            

            <code class="ruby">        illness_onset_date: &quot;2024-01-01&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="494">
            

            

            <code class="ruby">        condition: &quot;NORMAL&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="495">
            

            

            <code class="ruby">        medical_history: &quot;None&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="496">
            

            

            <code class="ruby">      },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="497">
            

            

            <code class="ruby">      status: &quot;pending_patient_approval&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="498">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="499">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="500">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="501">
            

            

            <code class="ruby">  # Returns the next Monday at the given hour/minute in the future</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="502">
            

            

            <code class="ruby">  # Ensures the returned time is in the future to avoid past date issues</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="503">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def next_monday_at(hour, minute)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="504">
            

            

            <code class="ruby">    today = Date.current</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="505">
            

            

            <code class="ruby">    # Find the next Monday (including today if today is Monday)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="506">
            

            

            <code class="ruby">    date = today</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="507">
            

            

            <code class="ruby">    date += 1.day until date.monday?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="508">
            

            

            <code class="ruby">    therapist_tz = @schedule&amp;.time_zone || Time.zone.name</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="509">
            

            

            <code class="ruby">    # Create the target time for this Monday in therapist&#39;s time zone</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="510">
            

            

            <code class="ruby">    time_in_tz = Time.use_zone(therapist_tz) { Time.zone.local(date.year, date.month, date.day, hour, minute) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="511">
            

            

            <code class="ruby">    # If the target time is in the past, go to next Monday</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="512">
            

            

            <code class="ruby">    if time_in_tz &lt;= Time.current.in_time_zone(therapist_tz)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="513">
            

            

            <code class="ruby">      date += 7.days</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="514">
            

            

            <code class="ruby">      time_in_tz = Time.use_zone(therapist_tz) { Time.zone.local(date.year, date.month, date.day, hour, minute) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="515">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="516">
            

            

            <code class="ruby">    time_in_tz</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="517">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="518">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="519">
            

            

            <code class="ruby">  # Returns the next Tuesday at the given hour/minute in the future</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="520">
            

            

            <code class="ruby">  # Ensures the returned time is in the future to avoid past date issues</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="521">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def next_tuesday_at(hour, minute)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="522">
            

            

            <code class="ruby">    today = Date.current</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="523">
            

            

            <code class="ruby">    # Find the next Tuesday</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="524">
            

            

            <code class="ruby">    date = today</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="525">
            

            

            <code class="ruby">    date += 1.day until date.tuesday?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="526">
            

            

            <code class="ruby">    therapist_tz = @schedule&amp;.time_zone || Time.zone.name</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="527">
            

            

            <code class="ruby">    # Create the target time for this Tuesday in therapist&#39;s time zone</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="528">
            

            

            <code class="ruby">    time_in_tz = Time.use_zone(therapist_tz) { Time.zone.local(date.year, date.month, date.day, hour, minute) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="529">
            

            

            <code class="ruby">    # If the target time is in the past, go to next Tuesday</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="530">
            

            

            <code class="ruby">    if time_in_tz &lt;= Time.current.in_time_zone(therapist_tz)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="531">
            

            

            <code class="ruby">      date += 7.days</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="532">
            

            

            <code class="ruby">      time_in_tz = Time.use_zone(therapist_tz) { Time.zone.local(date.year, date.month, date.day, hour, minute) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="533">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="534">
            

            

            <code class="ruby">    time_in_tz</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="535">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="536">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="537">
            

            

            <code class="ruby">  # Helper: Create max allowed appointments for a given day, spaced to avoid overlap</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="538">
            

            

            <code class="ruby">  # Creates the maximum number of appointments allowed per day for testing daily limits</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="539">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def create_max_daily_appointments(therapist, schedule, appointment_date)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="540">
            

            

            <code class="ruby">    max_appts = schedule.max_daily_appointments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="541">
            

            

            <code class="ruby">    max_appts.times do |i|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="542">
            

            

            <code class="ruby">      # Calculate appointment times with 70-minute spacing (60 min appointment + 10 min buffer)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="543">
            

            

            <code class="ruby">      appointment_hour = 16 + (i * 70 / 60)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="544">
            

            

            <code class="ruby">      appointment_minute = (i * 70) % 60</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="545">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="546">
            

            

            <code class="ruby">      Appointment.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="547">
            

            

            <code class="ruby">        therapist: therapist,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="548">
            

            

            <code class="ruby">        patient: Patient.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="549">
            

            

            <code class="ruby">          name: &quot;Patient#{i}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="550">
            

            

            <code class="ruby">          date_of_birth: &quot;2000-01-01&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="551">
            

            

            <code class="ruby">          gender: &quot;MALE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="552">
            

            

            <code class="ruby">          patient_contact: PatientContact.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="553">
            

            

            <code class="ruby">            contact_name: &quot;Patient#{i}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="554">
            

            

            <code class="ruby">            contact_phone: &quot;6289172123#{i}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="555">
            

            

            <code class="ruby">            email: &quot;patient#{i}@yopmail.com&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="556">
            

            

            <code class="ruby">          )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="557">
            

            

            <code class="ruby">        ),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="558">
            

            

            <code class="ruby">        service: Service.first,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="559">
            

            

            <code class="ruby">        package: Package.first,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="560">
            

            

            <code class="ruby">        location: Location.first,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="561">
            

            

            <code class="ruby">        appointment_date_time: Time.use_zone(schedule.time_zone) {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="562">
            

            

            <code class="ruby">          Time.zone.local(appointment_date.year, appointment_date.month, appointment_date.day, appointment_hour, appointment_minute)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="563">
            

            

            <code class="ruby">        },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="564">
            

            

            <code class="ruby">        preferred_therapist_gender: &quot;NO PREFERENCE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="565">
            

            

            <code class="ruby">        patient_medical_record_attributes: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="566">
            

            

            <code class="ruby">          complaint_description: &quot;Test complaint&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="567">
            

            

            <code class="ruby">          illness_onset_date: &quot;2024-01-01&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="568">
            

            

            <code class="ruby">          condition: &quot;NORMAL&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="569">
            

            

            <code class="ruby">          medical_history: &quot;None&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="570">
            

            

            <code class="ruby">        },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="571">
            

            

            <code class="ruby">        status: &quot;pending_patient_approval&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="572">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="573">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="574">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="575">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
      </div>
    </div>
  </body>
</html>
